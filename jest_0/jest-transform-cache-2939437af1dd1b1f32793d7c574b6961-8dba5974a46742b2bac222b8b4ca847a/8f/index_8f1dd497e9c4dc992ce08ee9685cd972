8496092bdbdd547ee85eeda6c6f8248f
Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require('react');var _react2=_interopRequireDefault(_react);
var _reactNative=require('react-native');




var _reservation=require('./reservation');var _reservation2=_interopRequireDefault(_reservation);
var _propTypes=require('prop-types');var _propTypes2=_interopRequireDefault(_propTypes);
var _xdate=require('xdate');var _xdate2=_interopRequireDefault(_xdate);

var _dateutils=require('../../dateutils');var _dateutils2=_interopRequireDefault(_dateutils);
var _style=require('./style');var _style2=_interopRequireDefault(_style);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var

ReactComp=function(_Component){_inherits(ReactComp,_Component);






















function ReactComp(props){_classCallCheck(this,ReactComp);var _this=_possibleConstructorReturn(this,(ReactComp.__proto__||Object.getPrototypeOf(ReactComp)).call(this,
props));
_this.styles=(0,_style2.default)(props.theme);
_this.state={
reservations:[]};

_this.heights=[];
_this.selectedDay=_this.props.selectedDay;
_this.scrollOver=true;return _this;
}_createClass(ReactComp,[{key:'componentWillMount',value:function componentWillMount()

{
this.updateDataSource(this.getReservations(this.props).reservations);
}},{key:'updateDataSource',value:function updateDataSource(

reservations){
this.setState({
reservations:reservations});

}},{key:'updateReservations',value:function updateReservations(

props){
var reservations=this.getReservations(props);
if(this.list&&!_dateutils2.default.sameDate(props.selectedDay,this.selectedDay)){
var scrollPosition=0;
for(var i=0;i<reservations.scrollPosition;i++){
scrollPosition+=this.heights[i]||0;
}
this.scrollOver=false;
this.list.scrollToOffset({offset:scrollPosition,animated:true});
}
this.selectedDay=props.selectedDay;
this.updateDataSource(reservations.reservations);
}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(

props){var _this2=this;
if(!_dateutils2.default.sameDate(props.topDay,this.props.topDay)){
this.setState({
reservations:[]},
function(){
_this2.updateReservations(props);
});
}else{
this.updateReservations(props);
}
}},{key:'onScroll',value:function onScroll(

event){
var yOffset=event.nativeEvent.contentOffset.y;
this.props.onScroll(yOffset);
var topRowOffset=0;
var topRow=void 0;
for(topRow=0;topRow<this.heights.length;topRow++){
if(topRowOffset+this.heights[topRow]/2>=yOffset){
break;
}
topRowOffset+=this.heights[topRow];
}
var row=this.state.reservations[topRow];
if(!row)return;
var day=row.day;
var sameDate=_dateutils2.default.sameDate(day,this.selectedDay);
if(!sameDate&&this.scrollOver){
this.selectedDay=day.clone();
this.props.onDayChange(day.clone());
}
}},{key:'onRowLayoutChange',value:function onRowLayoutChange(

ind,event){
this.heights[ind]=event.nativeEvent.layout.height;
}},{key:'renderRow',value:function renderRow(_ref)

{var item=_ref.item,index=_ref.index;
return(
_react2.default.createElement(_reactNative.View,{onLayout:this.onRowLayoutChange.bind(this,index)},
_react2.default.createElement(_reservation2.default,{
item:item,
renderItem:this.props.renderItem,
renderDay:this.props.renderDay,
renderEmptyDate:this.props.renderEmptyDate,
theme:this.props.theme,
rowHasChanged:this.props.rowHasChanged})));



}},{key:'getReservationsForDay',value:function getReservationsForDay(

iterator,props){
var day=iterator.clone();
var res=props.reservations[day.toString('yyyy-MM-dd')];
if(res&&res.length){
return res.map(function(reservation,i){
return{
reservation:reservation,
date:i?false:day,
day:day};

});
}else if(res){
return[{
date:iterator.clone(),
day:day}];

}else{
return false;
}
}},{key:'onListTouch',value:function onListTouch()

{
this.scrollOver=true;
}},{key:'getReservations',value:function getReservations(

props){
if(!props.reservations||!props.selectedDay){
return{reservations:[],scrollPosition:0};
}
var reservations=[];
if(this.state.reservations&&this.state.reservations.length){
var _iterator=this.state.reservations[0].day.clone();
while(_iterator.getTime()<props.selectedDay.getTime()){
var res=this.getReservationsForDay(_iterator,props);
if(!res){
reservations=[];
break;
}else{
reservations=reservations.concat(res);
}
_iterator.addDays(1);
}
}
var scrollPosition=reservations.length;
var iterator=props.selectedDay.clone();
for(var i=0;i<31;i++){
var _res=this.getReservationsForDay(iterator,props);
if(_res){
reservations=reservations.concat(_res);
}
iterator.addDays(1);
}

return{reservations:reservations,scrollPosition:scrollPosition};
}},{key:'render',value:function render()

{var _this3=this;
if(!this.props.reservations||!this.props.reservations[this.props.selectedDay.toString('yyyy-MM-dd')]){
return _react2.default.createElement(_reactNative.ActivityIndicator,{style:{marginTop:80}});
}
return(
_react2.default.createElement(_reactNative.FlatList,{
ref:function ref(c){return _this3.list=c;},
style:this.props.style,
renderItem:this.renderRow.bind(this),
data:this.state.reservations,
onScroll:this.onScroll.bind(this),
showsVerticalScrollIndicator:false,
scrollEventThrottle:200,
onMoveShouldSetResponderCapture:function onMoveShouldSetResponderCapture(){_this3.onListTouch();return false;},
keyExtractor:function keyExtractor(item,index){return index;}}));


}}]);return ReactComp;}(_react.Component);ReactComp.propTypes={rowHasChanged:_propTypes2.default.func,renderItem:_propTypes2.default.func,renderDay:_propTypes2.default.func,renderEmptyDate:_propTypes2.default.func,onDayChange:_propTypes2.default.func,onScroll:_propTypes2.default.func,reservations:_propTypes2.default.object,selectedDay:_propTypes2.default.instanceOf(_xdate2.default),topDay:_propTypes2.default.instanceOf(_xdate2.default)};exports.default=


ReactComp;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIlJlYWN0Q29tcCIsInByb3BzIiwic3R5bGVzIiwidGhlbWUiLCJzdGF0ZSIsInJlc2VydmF0aW9ucyIsImhlaWdodHMiLCJzZWxlY3RlZERheSIsInNjcm9sbE92ZXIiLCJ1cGRhdGVEYXRhU291cmNlIiwiZ2V0UmVzZXJ2YXRpb25zIiwic2V0U3RhdGUiLCJsaXN0Iiwic2FtZURhdGUiLCJzY3JvbGxQb3NpdGlvbiIsImkiLCJzY3JvbGxUb09mZnNldCIsIm9mZnNldCIsImFuaW1hdGVkIiwidG9wRGF5IiwidXBkYXRlUmVzZXJ2YXRpb25zIiwiZXZlbnQiLCJ5T2Zmc2V0IiwibmF0aXZlRXZlbnQiLCJjb250ZW50T2Zmc2V0IiwieSIsIm9uU2Nyb2xsIiwidG9wUm93T2Zmc2V0IiwidG9wUm93IiwibGVuZ3RoIiwicm93IiwiZGF5IiwiY2xvbmUiLCJvbkRheUNoYW5nZSIsImluZCIsImxheW91dCIsImhlaWdodCIsIml0ZW0iLCJpbmRleCIsIm9uUm93TGF5b3V0Q2hhbmdlIiwiYmluZCIsInJlbmRlckl0ZW0iLCJyZW5kZXJEYXkiLCJyZW5kZXJFbXB0eURhdGUiLCJyb3dIYXNDaGFuZ2VkIiwiaXRlcmF0b3IiLCJyZXMiLCJ0b1N0cmluZyIsIm1hcCIsInJlc2VydmF0aW9uIiwiZGF0ZSIsImdldFRpbWUiLCJnZXRSZXNlcnZhdGlvbnNGb3JEYXkiLCJjb25jYXQiLCJhZGREYXlzIiwibWFyZ2luVG9wIiwiYyIsInN0eWxlIiwicmVuZGVyUm93Iiwib25MaXN0VG91Y2giLCJwcm9wVHlwZXMiLCJmdW5jIiwib2JqZWN0IiwiaW5zdGFuY2VPZiJdLCJtYXBwaW5ncyI6InVqQkFBQSw0QjtBQUNBOzs7OztBQUtBLDBDO0FBQ0EscUM7QUFDQSw0Qjs7QUFFQSwwQztBQUNBLDhCOztBQUVNQSxTOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXVCSixtQkFBWUMsS0FBWixDQUFtQjtBQUNYQSxLQURXO0FBRWpCLE1BQUtD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QUFWLGlCQWxCSSxDQW1CakI1QyxPQUFRLG9CQUFVNEMsVUFBVixpQkFuQlMsQzs7O0FBeUxOL0QsUyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwge0NvbXBvbmVudH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHtcbiAgRmxhdExpc3QsXG4gIEFjdGl2aXR5SW5kaWNhdG9yLFxuICBWaWV3XG59IGZyb20gJ3JlYWN0LW5hdGl2ZSc7XG5pbXBvcnQgUmVzZXJ2YXRpb24gZnJvbSAnLi9yZXNlcnZhdGlvbic7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IFhEYXRlIGZyb20gJ3hkYXRlJztcblxuaW1wb3J0IGRhdGV1dGlscyBmcm9tICcuLi8uLi9kYXRldXRpbHMnO1xuaW1wb3J0IHN0eWxlQ29uc3RydWN0b3IgZnJvbSAnLi9zdHlsZSc7XG5cbmNsYXNzIFJlYWN0Q29tcCBleHRlbmRzIENvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgLy8gc3BlY2lmeSB5b3VyIGl0ZW0gY29tcGFyaXNvbiBmdW5jdGlvbiBmb3IgaW5jcmVhc2VkIHBlcmZvcm1hbmNlXG4gICAgcm93SGFzQ2hhbmdlZDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLy8gc3BlY2lmeSBob3cgZWFjaCBpdGVtIHNob3VsZCBiZSByZW5kZXJlZCBpbiBhZ2VuZGFcbiAgICByZW5kZXJJdGVtOiBQcm9wVHlwZXMuZnVuYyxcbiAgICAvLyBzcGVjaWZ5IGhvdyBlYWNoIGRhdGUgc2hvdWxkIGJlIHJlbmRlcmVkLiBkYXkgY2FuIGJlIHVuZGVmaW5lZCBpZiB0aGUgaXRlbSBpcyBub3QgZmlyc3QgaW4gdGhhdCBkYXkuXG4gICAgcmVuZGVyRGF5OiBQcm9wVHlwZXMuZnVuYyxcbiAgICAvLyBzcGVjaWZ5IGhvdyBlbXB0eSBkYXRlIGNvbnRlbnQgd2l0aCBubyBpdGVtcyBzaG91bGQgYmUgcmVuZGVyZWRcbiAgICByZW5kZXJFbXB0eURhdGU6IFByb3BUeXBlcy5mdW5jLFxuICAgIC8vIGNhbGxiYWNrIHRoYXQgZ2V0cyBjYWxsZWQgd2hlbiBkYXkgY2hhbmdlcyB3aGlsZSBzY3JvbGxpbmcgYWdlbmRhIGxpc3RcbiAgICBvbkRheUNoYW5nZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLy8gb25TY3JvbGwgTGlzdFZpZXcgZXZlbnRcbiAgICBvblNjcm9sbDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLy8gdGhlIGxpc3Qgb2YgaXRlbXMgdGhhdCBoYXZlIHRvIGJlIGRpc3BsYXllZCBpbiBhZ2VuZGEuIElmIHlvdSB3YW50IHRvIHJlbmRlciBpdGVtIGFzIGVtcHR5IGRhdGVcbiAgICAvLyB0aGUgdmFsdWUgb2YgZGF0ZSBrZXkga2FzIHRvIGJlIGFuIGVtcHR5IGFycmF5IFtdLiBJZiB0aGVyZSBleGlzdHMgbm8gdmFsdWUgZm9yIGRhdGUga2V5IGl0IGlzXG4gICAgLy8gY29uc2lkZXJlZCB0aGF0IHRoZSBkYXRlIGluIHF1ZXN0aW9uIGlzIG5vdCB5ZXQgbG9hZGVkXG4gICAgcmVzZXJ2YXRpb25zOiBQcm9wVHlwZXMub2JqZWN0LFxuXG4gICAgc2VsZWN0ZWREYXk6IFByb3BUeXBlcy5pbnN0YW5jZU9mKFhEYXRlKSxcbiAgICB0b3BEYXk6IFByb3BUeXBlcy5pbnN0YW5jZU9mKFhEYXRlKSxcbiAgfTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICB0aGlzLnN0eWxlcyA9IHN0eWxlQ29uc3RydWN0b3IocHJvcHMudGhlbWUpO1xuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICByZXNlcnZhdGlvbnM6IFtdXG4gICAgfTtcbiAgICB0aGlzLmhlaWdodHM9W107XG4gICAgdGhpcy5zZWxlY3RlZERheSA9IHRoaXMucHJvcHMuc2VsZWN0ZWREYXk7XG4gICAgdGhpcy5zY3JvbGxPdmVyID0gdHJ1ZTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxNb3VudCgpIHtcbiAgICB0aGlzLnVwZGF0ZURhdGFTb3VyY2UodGhpcy5nZXRSZXNlcnZhdGlvbnModGhpcy5wcm9wcykucmVzZXJ2YXRpb25zKTtcbiAgfVxuXG4gIHVwZGF0ZURhdGFTb3VyY2UocmVzZXJ2YXRpb25zKSB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICByZXNlcnZhdGlvbnNcbiAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZVJlc2VydmF0aW9ucyhwcm9wcykge1xuICAgIGNvbnN0IHJlc2VydmF0aW9ucyA9IHRoaXMuZ2V0UmVzZXJ2YXRpb25zKHByb3BzKTtcbiAgICBpZiAodGhpcy5saXN0ICYmICFkYXRldXRpbHMuc2FtZURhdGUocHJvcHMuc2VsZWN0ZWREYXksIHRoaXMuc2VsZWN0ZWREYXkpKSB7XG4gICAgICBsZXQgc2Nyb2xsUG9zaXRpb24gPSAwO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXNlcnZhdGlvbnMuc2Nyb2xsUG9zaXRpb247IGkrKykge1xuICAgICAgICBzY3JvbGxQb3NpdGlvbiArPSB0aGlzLmhlaWdodHNbaV0gfHwgMDtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2Nyb2xsT3ZlciA9IGZhbHNlO1xuICAgICAgdGhpcy5saXN0LnNjcm9sbFRvT2Zmc2V0KHtvZmZzZXQ6IHNjcm9sbFBvc2l0aW9uLCBhbmltYXRlZDogdHJ1ZX0pO1xuICAgIH1cbiAgICB0aGlzLnNlbGVjdGVkRGF5ID0gcHJvcHMuc2VsZWN0ZWREYXk7XG4gICAgdGhpcy51cGRhdGVEYXRhU291cmNlKHJlc2VydmF0aW9ucy5yZXNlcnZhdGlvbnMpO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhwcm9wcykge1xuICAgIGlmICghZGF0ZXV0aWxzLnNhbWVEYXRlKHByb3BzLnRvcERheSwgdGhpcy5wcm9wcy50b3BEYXkpKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgcmVzZXJ2YXRpb25zOiBbXVxuICAgICAgfSwgKCkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZVJlc2VydmF0aW9ucyhwcm9wcyk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51cGRhdGVSZXNlcnZhdGlvbnMocHJvcHMpO1xuICAgIH1cbiAgfVxuXG4gIG9uU2Nyb2xsKGV2ZW50KSB7XG4gICAgY29uc3QgeU9mZnNldCA9IGV2ZW50Lm5hdGl2ZUV2ZW50LmNvbnRlbnRPZmZzZXQueTtcbiAgICB0aGlzLnByb3BzLm9uU2Nyb2xsKHlPZmZzZXQpO1xuICAgIGxldCB0b3BSb3dPZmZzZXQgPSAwO1xuICAgIGxldCB0b3BSb3c7XG4gICAgZm9yICh0b3BSb3cgPSAwOyB0b3BSb3cgPCB0aGlzLmhlaWdodHMubGVuZ3RoOyB0b3BSb3crKykge1xuICAgICAgaWYgKHRvcFJvd09mZnNldCArIHRoaXMuaGVpZ2h0c1t0b3BSb3ddIC8gMiA+PSB5T2Zmc2V0KSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgdG9wUm93T2Zmc2V0ICs9IHRoaXMuaGVpZ2h0c1t0b3BSb3ddO1xuICAgIH1cbiAgICBjb25zdCByb3cgPSB0aGlzLnN0YXRlLnJlc2VydmF0aW9uc1t0b3BSb3ddO1xuICAgIGlmICghcm93KSByZXR1cm47XG4gICAgY29uc3QgZGF5ID0gcm93LmRheTtcbiAgICBjb25zdCBzYW1lRGF0ZSA9IGRhdGV1dGlscy5zYW1lRGF0ZShkYXksIHRoaXMuc2VsZWN0ZWREYXkpO1xuICAgIGlmICghc2FtZURhdGUgJiYgdGhpcy5zY3JvbGxPdmVyKSB7XG4gICAgICB0aGlzLnNlbGVjdGVkRGF5ID0gZGF5LmNsb25lKCk7XG4gICAgICB0aGlzLnByb3BzLm9uRGF5Q2hhbmdlKGRheS5jbG9uZSgpKTtcbiAgICB9XG4gIH1cblxuICBvblJvd0xheW91dENoYW5nZShpbmQsIGV2ZW50KSB7XG4gICAgdGhpcy5oZWlnaHRzW2luZF0gPSBldmVudC5uYXRpdmVFdmVudC5sYXlvdXQuaGVpZ2h0O1xuICB9XG5cbiAgcmVuZGVyUm93KHtpdGVtLCBpbmRleH0pIHtcbiAgICByZXR1cm4gKFxuICAgICAgPFZpZXcgb25MYXlvdXQ9e3RoaXMub25Sb3dMYXlvdXRDaGFuZ2UuYmluZCh0aGlzLCBpbmRleCl9PlxuICAgICAgICA8UmVzZXJ2YXRpb25cbiAgICAgICAgICBpdGVtPXtpdGVtfVxuICAgICAgICAgIHJlbmRlckl0ZW09e3RoaXMucHJvcHMucmVuZGVySXRlbX1cbiAgICAgICAgICByZW5kZXJEYXk9e3RoaXMucHJvcHMucmVuZGVyRGF5fVxuICAgICAgICAgIHJlbmRlckVtcHR5RGF0ZT17dGhpcy5wcm9wcy5yZW5kZXJFbXB0eURhdGV9XG4gICAgICAgICAgdGhlbWU9e3RoaXMucHJvcHMudGhlbWV9XG4gICAgICAgICAgcm93SGFzQ2hhbmdlZD17dGhpcy5wcm9wcy5yb3dIYXNDaGFuZ2VkfVxuICAgICAgICAvPlxuICAgICAgPC9WaWV3PlxuICAgICk7XG4gIH1cblxuICBnZXRSZXNlcnZhdGlvbnNGb3JEYXkoaXRlcmF0b3IsIHByb3BzKSB7XG4gICAgY29uc3QgZGF5ID0gaXRlcmF0b3IuY2xvbmUoKTtcbiAgICBjb25zdCByZXMgPSBwcm9wcy5yZXNlcnZhdGlvbnNbZGF5LnRvU3RyaW5nKCd5eXl5LU1NLWRkJyldO1xuICAgIGlmIChyZXMgJiYgcmVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHJlcy5tYXAoKHJlc2VydmF0aW9uLCBpKSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgcmVzZXJ2YXRpb24sXG4gICAgICAgICAgZGF0ZTogaSA/IGZhbHNlIDogZGF5LFxuICAgICAgICAgIGRheVxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChyZXMpIHtcbiAgICAgIHJldHVybiBbe1xuICAgICAgICBkYXRlOiBpdGVyYXRvci5jbG9uZSgpLFxuICAgICAgICBkYXlcbiAgICAgIH1dO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgb25MaXN0VG91Y2goKSB7XG4gICAgdGhpcy5zY3JvbGxPdmVyID0gdHJ1ZTtcbiAgfVxuXG4gIGdldFJlc2VydmF0aW9ucyhwcm9wcykge1xuICAgIGlmICghcHJvcHMucmVzZXJ2YXRpb25zIHx8ICFwcm9wcy5zZWxlY3RlZERheSkge1xuICAgICAgcmV0dXJuIHtyZXNlcnZhdGlvbnM6IFtdLCBzY3JvbGxQb3NpdGlvbjogMH07XG4gICAgfVxuICAgIGxldCByZXNlcnZhdGlvbnMgPSBbXTtcbiAgICBpZiAodGhpcy5zdGF0ZS5yZXNlcnZhdGlvbnMgJiYgdGhpcy5zdGF0ZS5yZXNlcnZhdGlvbnMubGVuZ3RoKSB7XG4gICAgICBjb25zdCBpdGVyYXRvciA9IHRoaXMuc3RhdGUucmVzZXJ2YXRpb25zWzBdLmRheS5jbG9uZSgpO1xuICAgICAgd2hpbGUgKGl0ZXJhdG9yLmdldFRpbWUoKSA8IHByb3BzLnNlbGVjdGVkRGF5LmdldFRpbWUoKSkge1xuICAgICAgICBjb25zdCByZXMgPSB0aGlzLmdldFJlc2VydmF0aW9uc0ZvckRheShpdGVyYXRvciwgcHJvcHMpO1xuICAgICAgICBpZiAoIXJlcykge1xuICAgICAgICAgIHJlc2VydmF0aW9ucyA9IFtdO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc2VydmF0aW9ucyA9IHJlc2VydmF0aW9ucy5jb25jYXQocmVzKTtcbiAgICAgICAgfVxuICAgICAgICBpdGVyYXRvci5hZGREYXlzKDEpO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBzY3JvbGxQb3NpdGlvbiA9IHJlc2VydmF0aW9ucy5sZW5ndGg7XG4gICAgY29uc3QgaXRlcmF0b3IgPSBwcm9wcy5zZWxlY3RlZERheS5jbG9uZSgpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzE7IGkrKykge1xuICAgICAgY29uc3QgcmVzID0gdGhpcy5nZXRSZXNlcnZhdGlvbnNGb3JEYXkoaXRlcmF0b3IsIHByb3BzKTtcbiAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgcmVzZXJ2YXRpb25zID0gcmVzZXJ2YXRpb25zLmNvbmNhdChyZXMpO1xuICAgICAgfVxuICAgICAgaXRlcmF0b3IuYWRkRGF5cygxKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge3Jlc2VydmF0aW9ucywgc2Nyb2xsUG9zaXRpb259O1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGlmICghdGhpcy5wcm9wcy5yZXNlcnZhdGlvbnMgfHwgIXRoaXMucHJvcHMucmVzZXJ2YXRpb25zW3RoaXMucHJvcHMuc2VsZWN0ZWREYXkudG9TdHJpbmcoJ3l5eXktTU0tZGQnKV0pIHtcbiAgICAgIHJldHVybiAoPEFjdGl2aXR5SW5kaWNhdG9yIHN0eWxlPXt7bWFyZ2luVG9wOiA4MH19Lz4pO1xuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgPEZsYXRMaXN0XG4gICAgICAgIHJlZj17KGMpID0+IHRoaXMubGlzdCA9IGN9XG4gICAgICAgIHN0eWxlPXt0aGlzLnByb3BzLnN0eWxlfVxuICAgICAgICByZW5kZXJJdGVtPXt0aGlzLnJlbmRlclJvdy5iaW5kKHRoaXMpfVxuICAgICAgICBkYXRhPXt0aGlzLnN0YXRlLnJlc2VydmF0aW9uc31cbiAgICAgICAgb25TY3JvbGw9e3RoaXMub25TY3JvbGwuYmluZCh0aGlzKX1cbiAgICAgICAgc2hvd3NWZXJ0aWNhbFNjcm9sbEluZGljYXRvcj17ZmFsc2V9XG4gICAgICAgIHNjcm9sbEV2ZW50VGhyb3R0bGU9ezIwMH1cbiAgICAgICAgb25Nb3ZlU2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZT17KCkgPT4ge3RoaXMub25MaXN0VG91Y2goKTsgcmV0dXJuIGZhbHNlO319XG4gICAgICAgIGtleUV4dHJhY3Rvcj17KGl0ZW0sIGluZGV4KSA9PiBpbmRleH1cbiAgICAgIC8+XG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBSZWFjdENvbXA7XG4iXX0=
ec6c680bc2af0c987ffe829102ba250c











'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}

var Blob=require('Blob');
var EventTarget=require('event-target-shim');
var NativeEventEmitter=require('NativeEventEmitter');
var NativeModules=require('NativeModules');
var Platform=require('Platform');
var WebSocketEvent=require('WebSocketEvent');

var base64=require('base64-js');
var binaryToBase64=require('binaryToBase64');
var invariant=require('fbjs/lib/invariant');var

WebSocketModule=NativeModules.WebSocketModule;

















var CONNECTING=0;
var OPEN=1;
var CLOSING=2;
var CLOSED=3;

var CLOSE_NORMAL=1000;

var WEBSOCKET_EVENTS=[
'close',
'error',
'message',
'open'];


var nextWebSocketId=0;var







WebSocket=function(_EventTarget){_inherits(WebSocket,_EventTarget);






























function WebSocket(url,protocols,options){_classCallCheck(this,WebSocket);var _this=_possibleConstructorReturn(this,(WebSocket.__proto__||Object.getPrototypeOf(WebSocket)).call(this));_this.CONNECTING=CONNECTING;_this.OPEN=OPEN;_this.CLOSING=CLOSING;_this.CLOSED=CLOSED;_this.readyState=CONNECTING;

if(typeof protocols==='string'){
protocols=[protocols];
}

if(!Array.isArray(protocols)){
protocols=null;
}

if(!WebSocket.isAvailable){
throw new Error('Cannot initialize WebSocket module. '+
'Native module WebSocketModule is missing.');
}

_this._eventEmitter=new NativeEventEmitter(WebSocketModule);
_this._socketId=nextWebSocketId++;
_this._registerEvents();
WebSocketModule.connect(url,protocols,options,_this._socketId);return _this;
}_createClass(WebSocket,[{key:'close',value:function close(























code,reason){
if(this.readyState===this.CLOSING||
this.readyState===this.CLOSED){
return;
}

this.readyState=this.CLOSING;
this._close(code,reason);
}},{key:'send',value:function send(

data){
if(this.readyState===this.CONNECTING){
throw new Error('INVALID_STATE_ERR');
}

if(data instanceof Blob){
var BlobModule=NativeModules.BlobModule;
invariant(BlobModule,'Native module BlobModule is required for blob support');
BlobModule.sendBlob(data,this._socketId);
return;
}

if(typeof data==='string'){
WebSocketModule.send(data,this._socketId);
return;
}

if(data instanceof ArrayBuffer||ArrayBuffer.isView(data)){
WebSocketModule.sendBinary(binaryToBase64(data),this._socketId);
return;
}

throw new Error('Unsupported data type');
}},{key:'ping',value:function ping()

{
if(this.readyState===this.CONNECTING){
throw new Error('INVALID_STATE_ERR');
}

WebSocketModule.ping(this._socketId);
}},{key:'_close',value:function _close(

code,reason){
if(Platform.OS==='android'){

var statusCode=typeof code==='number'?code:CLOSE_NORMAL;
var closeReason=typeof reason==='string'?reason:'';
WebSocketModule.close(statusCode,closeReason,this._socketId);
}else{
WebSocketModule.close(this._socketId);
}
}},{key:'_unregisterEvents',value:function _unregisterEvents()

{
this._subscriptions.forEach(function(e){return e.remove();});
this._subscriptions=[];
}},{key:'_registerEvents',value:function _registerEvents()

{var _this2=this;
this._subscriptions=[
this._eventEmitter.addListener('websocketMessage',function(ev){
if(ev.id!==_this2._socketId){
return;
}
var data=ev.data;
switch(ev.type){
case'binary':
data=base64.toByteArray(ev.data).buffer;
break;
case'blob':
data=Blob.create(ev.data);
break;}

_this2.dispatchEvent(new WebSocketEvent('message',{data:data}));
}),
this._eventEmitter.addListener('websocketOpen',function(ev){
if(ev.id!==_this2._socketId){
return;
}
_this2.readyState=_this2.OPEN;
_this2.dispatchEvent(new WebSocketEvent('open'));
}),
this._eventEmitter.addListener('websocketClosed',function(ev){
if(ev.id!==_this2._socketId){
return;
}
_this2.readyState=_this2.CLOSED;
_this2.dispatchEvent(new WebSocketEvent('close',{
code:ev.code,
reason:ev.reason}));

_this2._unregisterEvents();
_this2.close();
}),
this._eventEmitter.addListener('websocketFailed',function(ev){
if(ev.id!==_this2._socketId){
return;
}
_this2.readyState=_this2.CLOSED;
_this2.dispatchEvent(new WebSocketEvent('error',{
message:ev.message}));

_this2.dispatchEvent(new WebSocketEvent('close',{
message:ev.message}));

_this2._unregisterEvents();
_this2.close();
})];

}},{key:'binaryType',get:function get(){return this._binaryType;},set:function set(binaryType){if(binaryType!=='blob'&&binaryType!=='arraybuffer'){throw new Error('binaryType must be either \'blob\' or \'arraybuffer\'');}if(this._binaryType==='blob'||binaryType==='blob'){var BlobModule=NativeModules.BlobModule;invariant(BlobModule,'Native module BlobModule is required for blob support');if(BlobModule){if(binaryType==='blob'){BlobModule.enableBlobSupport(this._socketId);}else{BlobModule.disableBlobSupport(this._socketId);}}}this._binaryType=binaryType;}}]);return WebSocket;}(EventTarget.apply(undefined,WEBSOCKET_EVENTS));WebSocket.CONNECTING=CONNECTING;WebSocket.OPEN=OPEN;WebSocket.CLOSING=CLOSING;WebSocket.CLOSED=CLOSED;WebSocket.isAvailable=!!WebSocketModule;


module.exports=WebSocket;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIldlYlNvY2tldC5qcyJdLCJuYW1lcyI6WyJCbG9iIiwicmVxdWlyZSIsIkV2ZW50VGFyZ2V0IiwiTmF0aXZlRXZlbnRFbWl0dGVyIiwiTmF0aXZlTW9kdWxlcyIsIlBsYXRmb3JtIiwiV2ViU29ja2V0RXZlbnQiLCJiYXNlNjQiLCJiaW5hcnlUb0Jhc2U2NCIsImludmFyaWFudCIsIldlYlNvY2tldE1vZHVsZSIsIkNPTk5FQ1RJTkciLCJPUEVOIiwiQ0xPU0lORyIsIkNMT1NFRCIsIkNMT1NFX05PUk1BTCIsIldFQlNPQ0tFVF9FVkVOVFMiLCJuZXh0V2ViU29ja2V0SWQiLCJXZWJTb2NrZXQiLCJ1cmwiLCJwcm90b2NvbHMiLCJvcHRpb25zIiwicmVhZHlTdGF0ZSIsIkFycmF5IiwiaXNBcnJheSIsImlzQXZhaWxhYmxlIiwiRXJyb3IiLCJfZXZlbnRFbWl0dGVyIiwiX3NvY2tldElkIiwiX3JlZ2lzdGVyRXZlbnRzIiwiY29ubmVjdCIsImNvZGUiLCJyZWFzb24iLCJfY2xvc2UiLCJkYXRhIiwiQmxvYk1vZHVsZSIsInNlbmRCbG9iIiwic2VuZCIsIkFycmF5QnVmZmVyIiwiaXNWaWV3Iiwic2VuZEJpbmFyeSIsInBpbmciLCJPUyIsInN0YXR1c0NvZGUiLCJjbG9zZVJlYXNvbiIsImNsb3NlIiwiX3N1YnNjcmlwdGlvbnMiLCJmb3JFYWNoIiwiZSIsInJlbW92ZSIsImFkZExpc3RlbmVyIiwiZXYiLCJpZCIsInR5cGUiLCJ0b0J5dGVBcnJheSIsImJ1ZmZlciIsImNyZWF0ZSIsImRpc3BhdGNoRXZlbnQiLCJfdW5yZWdpc3RlckV2ZW50cyIsIm1lc3NhZ2UiLCJfYmluYXJ5VHlwZSIsImJpbmFyeVR5cGUiLCJlbmFibGVCbG9iU3VwcG9ydCIsImRpc2FibGVCbG9iU3VwcG9ydCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBV0EsYTs7QUFFQSxHQUFNQSxNQUFPQyxRQUFRLE1BQVIsQ0FBYjtBQUNBLEdBQU1DLGFB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LENBQVNBLE0sQ0FKWkksUyxDQTZCR08sVyxDQUF1QixDQUFDLENBQUNmLGU7OztBQThKbENzRCxPQUFPQyxPQUFQLENBQWlCL0MsU0FBakIiLCJmaWxlIjoiV2ViU29ja2V0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxuICpcbiAqIEBwcm92aWRlc01vZHVsZSBXZWJTb2NrZXRcbiAqIEBmbG93XG4gKi9cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgQmxvYiA9IHJlcXVpcmUoJ0Jsb2InKTtcbmNvbnN0IEV2ZW50VGFyZ2V0ID0gcmVxdWlyZSgnZXZlbnQtdGFyZ2V0LXNoaW0nKTtcbmNvbnN0IE5hdGl2ZUV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ05hdGl2ZUV2ZW50RW1pdHRlcicpO1xuY29uc3QgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoJ05hdGl2ZU1vZHVsZXMnKTtcbmNvbnN0IFBsYXRmb3JtID0gcmVxdWlyZSgnUGxhdGZvcm0nKTtcbmNvbnN0IFdlYlNvY2tldEV2ZW50ID0gcmVxdWlyZSgnV2ViU29ja2V0RXZlbnQnKTtcblxuY29uc3QgYmFzZTY0ID0gcmVxdWlyZSgnYmFzZTY0LWpzJyk7XG5jb25zdCBiaW5hcnlUb0Jhc2U2NCA9IHJlcXVpcmUoJ2JpbmFyeVRvQmFzZTY0Jyk7XG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdmYmpzL2xpYi9pbnZhcmlhbnQnKTtcblxuY29uc3Qge1dlYlNvY2tldE1vZHVsZX0gPSBOYXRpdmVNb2R1bGVzO1xuXG5pbXBvcnQgdHlwZSBFdmVudFN1YnNjcmlwdGlvbiBmcm9tICdFdmVudFN1YnNjcmlwdGlvbic7XG5cbnR5cGUgQXJyYXlCdWZmZXJWaWV3ID1cbiAgfCBJbnQ4QXJyYXlcbiAgfCBVaW50OEFycmF5XG4gIHwgVWludDhDbGFtcGVkQXJyYXlcbiAgfCBJbnQxNkFycmF5XG4gIHwgVWludDE2QXJyYXlcbiAgfCBJbnQzMkFycmF5XG4gIHwgVWludDMyQXJyYXlcbiAgfCBGbG9hdDMyQXJyYXlcbiAgfCBGbG9hdDY0QXJyYXlcbiAgfCBEYXRhVmlld1xuXG50eXBlIEJpbmFyeVR5cGUgPSAnYmxvYicgfCAnYXJyYXlidWZmZXInXG5cbmNvbnN0IENPTk5FQ1RJTkcgPSAwO1xuY29uc3QgT1BFTiA9IDE7XG5jb25zdCBDTE9TSU5HID0gMjtcbmNvbnN0IENMT1NFRCA9IDM7XG5cbmNvbnN0IENMT1NFX05PUk1BTCA9IDEwMDA7XG5cbmNvbnN0IFdFQlNPQ0tFVF9FVkVOVFMgPSBbXG4gICdjbG9zZScsXG4gICdlcnJvcicsXG4gICdtZXNzYWdlJyxcbiAgJ29wZW4nLFxuXTtcblxubGV0IG5leHRXZWJTb2NrZXRJZCA9IDA7XG5cbi8qKlxuICogQnJvd3Nlci1jb21wYXRpYmxlIFdlYlNvY2tldHMgaW1wbGVtZW50YXRpb24uXG4gKlxuICogU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9XZWJTb2NrZXRcbiAqIFNlZSBodHRwczovL2dpdGh1Yi5jb20vd2Vic29ja2V0cy93c1xuICovXG5jbGFzcyBXZWJTb2NrZXQgZXh0ZW5kcyBFdmVudFRhcmdldCguLi5XRUJTT0NLRVRfRVZFTlRTKSB7XG4gIHN0YXRpYyBDT05ORUNUSU5HID0gQ09OTkVDVElORztcbiAgc3RhdGljIE9QRU4gPSBPUEVOO1xuICBzdGF0aWMgQ0xPU0lORyA9IENMT1NJTkc7XG4gIHN0YXRpYyBDTE9TRUQgPSBDTE9TRUQ7XG5cbiAgQ09OTkVDVElORzogbnVtYmVyID0gQ09OTkVDVElORztcbiAgT1BFTjogbnVtYmVyID0gT1BFTjtcbiAgQ0xPU0lORzogbnVtYmVyID0gQ0xPU0lORztcbiAgQ0xPU0VEOiBudW1iZXIgPSBDTE9TRUQ7XG5cbiAgX3NvY2tldElkOiBudW1iZXI7XG4gIF9ldmVudEVtaXR0ZXI6IE5hdGl2ZUV2ZW50RW1pdHRlcjtcbiAgX3N1YnNjcmlwdGlvbnM6IEFycmF5PEV2ZW50U3Vic2NyaXB0aW9uPjtcbiAgX2JpbmFyeVR5cGU6ID9CaW5hcnlUeXBlO1xuXG4gIG9uY2xvc2U6ID9GdW5jdGlvbjtcbiAgb25lcnJvcjogP0Z1bmN0aW9uO1xuICBvbm1lc3NhZ2U6ID9GdW5jdGlvbjtcbiAgb25vcGVuOiA/RnVuY3Rpb247XG5cbiAgYnVmZmVyZWRBbW91bnQ6IG51bWJlcjtcbiAgZXh0ZW5zaW9uOiA/c3RyaW5nO1xuICBwcm90b2NvbDogP3N0cmluZztcbiAgcmVhZHlTdGF0ZTogbnVtYmVyID0gQ09OTkVDVElORztcbiAgdXJsOiA/c3RyaW5nO1xuXG4gIC8vIFRoaXMgbW9kdWxlIGRlcGVuZHMgb24gdGhlIG5hdGl2ZSBgV2ViU29ja2V0TW9kdWxlYCBtb2R1bGUuIElmIHlvdSBkb24ndCBpbmNsdWRlIGl0LFxuICAvLyBgV2ViU29ja2V0LmlzQXZhaWxhYmxlYCB3aWxsIHJldHVybiBgZmFsc2VgLCBhbmQgV2ViU29ja2V0IGNvbnN0cnVjdG9yIHdpbGwgdGhyb3cgYW4gZXJyb3JcbiAgc3RhdGljIGlzQXZhaWxhYmxlOiBib29sZWFuID0gISFXZWJTb2NrZXRNb2R1bGU7XG5cbiAgY29uc3RydWN0b3IodXJsOiBzdHJpbmcsIHByb3RvY29sczogP3N0cmluZyB8ID9BcnJheTxzdHJpbmc+LCBvcHRpb25zOiA/e29yaWdpbj86IHN0cmluZ30pIHtcbiAgICBzdXBlcigpO1xuICAgIGlmICh0eXBlb2YgcHJvdG9jb2xzID09PSAnc3RyaW5nJykge1xuICAgICAgcHJvdG9jb2xzID0gW3Byb3RvY29sc107XG4gICAgfVxuXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHByb3RvY29scykpIHtcbiAgICAgIHByb3RvY29scyA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKCFXZWJTb2NrZXQuaXNBdmFpbGFibGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGluaXRpYWxpemUgV2ViU29ja2V0IG1vZHVsZS4gJyArXG4gICAgICAnTmF0aXZlIG1vZHVsZSBXZWJTb2NrZXRNb2R1bGUgaXMgbWlzc2luZy4nKTtcbiAgICB9XG5cbiAgICB0aGlzLl9ldmVudEVtaXR0ZXIgPSBuZXcgTmF0aXZlRXZlbnRFbWl0dGVyKFdlYlNvY2tldE1vZHVsZSk7XG4gICAgdGhpcy5fc29ja2V0SWQgPSBuZXh0V2ViU29ja2V0SWQrKztcbiAgICB0aGlzLl9yZWdpc3RlckV2ZW50cygpO1xuICAgIFdlYlNvY2tldE1vZHVsZS5jb25uZWN0KHVybCwgcHJvdG9jb2xzLCBvcHRpb25zLCB0aGlzLl9zb2NrZXRJZCk7XG4gIH1cblxuICBnZXQgYmluYXJ5VHlwZSgpOiA/QmluYXJ5VHlwZSB7XG4gICAgcmV0dXJuIHRoaXMuX2JpbmFyeVR5cGU7XG4gIH1cblxuICBzZXQgYmluYXJ5VHlwZShiaW5hcnlUeXBlOiBCaW5hcnlUeXBlKTogdm9pZCB7XG4gICAgaWYgKGJpbmFyeVR5cGUgIT09ICdibG9iJyAmJiBiaW5hcnlUeXBlICE9PSAnYXJyYXlidWZmZXInKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JpbmFyeVR5cGUgbXVzdCBiZSBlaXRoZXIgXFwnYmxvYlxcJyBvciBcXCdhcnJheWJ1ZmZlclxcJycpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fYmluYXJ5VHlwZSA9PT0gJ2Jsb2InIHx8IGJpbmFyeVR5cGUgPT09ICdibG9iJykge1xuICAgICAgY29uc3QgQmxvYk1vZHVsZSA9IE5hdGl2ZU1vZHVsZXMuQmxvYk1vZHVsZTtcbiAgICAgIGludmFyaWFudChCbG9iTW9kdWxlLCAnTmF0aXZlIG1vZHVsZSBCbG9iTW9kdWxlIGlzIHJlcXVpcmVkIGZvciBibG9iIHN1cHBvcnQnKTtcbiAgICAgIGlmIChCbG9iTW9kdWxlKSB7XG4gICAgICAgIGlmIChiaW5hcnlUeXBlID09PSAnYmxvYicpIHtcbiAgICAgICAgICBCbG9iTW9kdWxlLmVuYWJsZUJsb2JTdXBwb3J0KHRoaXMuX3NvY2tldElkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBCbG9iTW9kdWxlLmRpc2FibGVCbG9iU3VwcG9ydCh0aGlzLl9zb2NrZXRJZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fYmluYXJ5VHlwZSA9IGJpbmFyeVR5cGU7XG4gIH1cblxuICBjbG9zZShjb2RlPzogbnVtYmVyLCByZWFzb24/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkNMT1NJTkcgfHxcbiAgICAgICAgdGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkNMT1NFRCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucmVhZHlTdGF0ZSA9IHRoaXMuQ0xPU0lORztcbiAgICB0aGlzLl9jbG9zZShjb2RlLCByZWFzb24pO1xuICB9XG5cbiAgc2VuZChkYXRhOiBzdHJpbmcgfCBBcnJheUJ1ZmZlciB8IEFycmF5QnVmZmVyVmlldyB8IEJsb2IpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkNPTk5FQ1RJTkcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSU5WQUxJRF9TVEFURV9FUlInKTtcbiAgICB9XG5cbiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEJsb2IpIHtcbiAgICAgIGNvbnN0IEJsb2JNb2R1bGUgPSBOYXRpdmVNb2R1bGVzLkJsb2JNb2R1bGU7XG4gICAgICBpbnZhcmlhbnQoQmxvYk1vZHVsZSwgJ05hdGl2ZSBtb2R1bGUgQmxvYk1vZHVsZSBpcyByZXF1aXJlZCBmb3IgYmxvYiBzdXBwb3J0Jyk7XG4gICAgICBCbG9iTW9kdWxlLnNlbmRCbG9iKGRhdGEsIHRoaXMuX3NvY2tldElkKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICBXZWJTb2NrZXRNb2R1bGUuc2VuZChkYXRhLCB0aGlzLl9zb2NrZXRJZCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciB8fCBBcnJheUJ1ZmZlci5pc1ZpZXcoZGF0YSkpIHtcbiAgICAgIFdlYlNvY2tldE1vZHVsZS5zZW5kQmluYXJ5KGJpbmFyeVRvQmFzZTY0KGRhdGEpLCB0aGlzLl9zb2NrZXRJZCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCBkYXRhIHR5cGUnKTtcbiAgfVxuXG4gIHBpbmcoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gdGhpcy5DT05ORUNUSU5HKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSU5WQUxJRF9TVEFURV9FUlInKTtcbiAgICB9XG5cbiAgICBXZWJTb2NrZXRNb2R1bGUucGluZyh0aGlzLl9zb2NrZXRJZCk7XG4gIH1cblxuICBfY2xvc2UoY29kZT86IG51bWJlciwgcmVhc29uPzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHtcbiAgICAgIC8vIFNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvQ2xvc2VFdmVudFxuICAgICAgY29uc3Qgc3RhdHVzQ29kZSA9IHR5cGVvZiBjb2RlID09PSAnbnVtYmVyJyA/IGNvZGUgOiBDTE9TRV9OT1JNQUw7XG4gICAgICBjb25zdCBjbG9zZVJlYXNvbiA9IHR5cGVvZiByZWFzb24gPT09ICdzdHJpbmcnID8gcmVhc29uIDogJyc7XG4gICAgICBXZWJTb2NrZXRNb2R1bGUuY2xvc2Uoc3RhdHVzQ29kZSwgY2xvc2VSZWFzb24sIHRoaXMuX3NvY2tldElkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgV2ViU29ja2V0TW9kdWxlLmNsb3NlKHRoaXMuX3NvY2tldElkKTtcbiAgICB9XG4gIH1cblxuICBfdW5yZWdpc3RlckV2ZW50cygpOiB2b2lkIHtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmZvckVhY2goZSA9PiBlLnJlbW92ZSgpKTtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gW107XG4gIH1cblxuICBfcmVnaXN0ZXJFdmVudHMoKTogdm9pZCB7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IFtcbiAgICAgIHRoaXMuX2V2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignd2Vic29ja2V0TWVzc2FnZScsIGV2ID0+IHtcbiAgICAgICAgaWYgKGV2LmlkICE9PSB0aGlzLl9zb2NrZXRJZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgZGF0YSA9IGV2LmRhdGE7XG4gICAgICAgIHN3aXRjaCAoZXYudHlwZSkge1xuICAgICAgICAgIGNhc2UgJ2JpbmFyeSc6XG4gICAgICAgICAgICBkYXRhID0gYmFzZTY0LnRvQnl0ZUFycmF5KGV2LmRhdGEpLmJ1ZmZlcjtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2Jsb2InOlxuICAgICAgICAgICAgZGF0YSA9IEJsb2IuY3JlYXRlKGV2LmRhdGEpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBXZWJTb2NrZXRFdmVudCgnbWVzc2FnZScsIHsgZGF0YSB9KSk7XG4gICAgICB9KSxcbiAgICAgIHRoaXMuX2V2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignd2Vic29ja2V0T3BlbicsIGV2ID0+IHtcbiAgICAgICAgaWYgKGV2LmlkICE9PSB0aGlzLl9zb2NrZXRJZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlYWR5U3RhdGUgPSB0aGlzLk9QRU47XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgV2ViU29ja2V0RXZlbnQoJ29wZW4nKSk7XG4gICAgICB9KSxcbiAgICAgIHRoaXMuX2V2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignd2Vic29ja2V0Q2xvc2VkJywgZXYgPT4ge1xuICAgICAgICBpZiAoZXYuaWQgIT09IHRoaXMuX3NvY2tldElkKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVhZHlTdGF0ZSA9IHRoaXMuQ0xPU0VEO1xuICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IFdlYlNvY2tldEV2ZW50KCdjbG9zZScsIHtcbiAgICAgICAgICBjb2RlOiBldi5jb2RlLFxuICAgICAgICAgIHJlYXNvbjogZXYucmVhc29uLFxuICAgICAgICB9KSk7XG4gICAgICAgIHRoaXMuX3VucmVnaXN0ZXJFdmVudHMoKTtcbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgfSksXG4gICAgICB0aGlzLl9ldmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoJ3dlYnNvY2tldEZhaWxlZCcsIGV2ID0+IHtcbiAgICAgICAgaWYgKGV2LmlkICE9PSB0aGlzLl9zb2NrZXRJZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlYWR5U3RhdGUgPSB0aGlzLkNMT1NFRDtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBXZWJTb2NrZXRFdmVudCgnZXJyb3InLCB7XG4gICAgICAgICAgbWVzc2FnZTogZXYubWVzc2FnZSxcbiAgICAgICAgfSkpO1xuICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IFdlYlNvY2tldEV2ZW50KCdjbG9zZScsIHtcbiAgICAgICAgICBtZXNzYWdlOiBldi5tZXNzYWdlLFxuICAgICAgICB9KSk7XG4gICAgICAgIHRoaXMuX3VucmVnaXN0ZXJFdmVudHMoKTtcbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgfSlcbiAgICBdO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gV2ViU29ja2V0O1xuIl19
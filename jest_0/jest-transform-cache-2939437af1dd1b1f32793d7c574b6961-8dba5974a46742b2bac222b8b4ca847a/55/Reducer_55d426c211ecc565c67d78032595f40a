d328712c6609e4989a6a2a1f5bf505f9
Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};exports.













































































































































































































































































findElement=findElement;exports.












getCurrent=getCurrent;var _reactNative=require('react-native');var _ActionConst=require('./ActionConst');var ActionConst=_interopRequireWildcard(_ActionConst);var _Actions=require('./Actions');var _Util=require('./Util');var _State=require('./State');function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function checkPropertiesEqual(action,lastAction){var isEqual=true;for(var _iterator=Object.keys(action),_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==='function'?Symbol.iterator:'@@iterator']();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var key=_ref;if(['key','type','parent'].indexOf(key)===-1){if(action[key]!==lastAction[key]){isEqual=false;}}}return isEqual;}function resetHistoryStack(child){var newChild=child;newChild.index=0;child.children.map(function(el,i){if(el.initial){newChild.index=i;if(!newChild.tabs){newChild.children=[el];}}if(el.children){resetHistoryStack(el);}return newChild;});}function refreshTopChild(children,refresh){if(refresh){var topChild=children[children.length-1];return[].concat(_toConsumableArray(children.slice(0,-1)),[_extends({},topChild,refresh)]);}return children;}function inject(state,action,props,scenes){var condition=_Actions.ActionMap[action.type]===ActionConst.REFRESH?state.key===props.key||state.sceneKey===action.key:state.sceneKey===props.parent;if(!condition){if(state.children){var res=state.children.map(function(el){return inject(el,action,props,scenes);});var changed=false;var changedIndex=-1;for(var i=0;i<res.length;i+=1){if(res[i]!==state.children[i]){changed=true;changedIndex=i;break;}}return changed?_extends({},state,{children:res,index:changedIndex}):state;}return state;}var ind=void 0;switch(_Actions.ActionMap[action.type]){case ActionConst.POP_TO:{var targetIndex=action.targetIndex;return _extends({},state,{index:targetIndex,children:refreshTopChild(state.children.slice(0,targetIndex+1),action.refresh)});}case ActionConst.BACK:case ActionConst.BACK_ACTION:{(0,_Util.assert)(!state.tabs,'pop() operation cannot be run on tab bar (tabs=true)');if(state.index===0){return state;}var popNum=1;if(action.popNum){(0,_Util.assert)(typeof action.popNum==='number','The data is the number of scenes you want to pop, it must be Number');popNum=action.popNum;(0,_Util.assert)(popNum%1===0,'The data is the number of scenes you want to pop, it must be integer.');(0,_Util.assert)(popNum>1,'The data is the number of scenes you want to pop, it must be bigger than 1.');(0,_Util.assert)(popNum<=state.index,'The data is the number of scenes you want to pop, '+"it must be smaller than scenes stack's length.");}return _extends({},state,{index:state.index-popNum,from:state.children[state.children.length-popNum],children:refreshTopChild(state.children.slice(0,-1*popNum),action.refresh)});}case ActionConst.ANDROID_BACK:{if(_reactNative.Platform.OS==='android'){(0,_Util.assert)(state.index>0,'You are already in the root scene.');}return _extends({},state,{index:state.index-1,from:state.children[state.children.length-1],children:refreshTopChild(state.children.slice(0,-1),action.refresh)});}case ActionConst.POP_AND_REPLACE:{(0,_Util.assert)(!state.tabs,'pop() operation cannot be run on tab bar (tabs=true)');(0,_Util.assert)(state.index>0,'You are already in the root scene.');var _popNum=1;if(action.popNum){(0,_Util.assert)(typeof action.popNum==='number','The data is the number of scenes you want to pop, it must be Number');_popNum=action.popNum;(0,_Util.assert)(_popNum%1===0,'The data is the number of scenes you want to pop, it must be integer.');(0,_Util.assert)(_popNum>1,'The data is the number of scenes you want to pop, it must be bigger than 1.');(0,_Util.assert)(_popNum<=state.index,'The data is the number of scenes you want to pop, '+"it must be smaller than scenes stack's length.");}state=_extends({},state,{index:state.index-_popNum,from:state.children[state.children.length-_popNum],children:state.children.slice(0,-1*_popNum)});if(state.children[state.index].sceneKey===action.key){return state;}var newAction=_extends({duration:0},action);delete newAction.popNum;var newProps=_extends({},props);delete newProps.popNum;state.children[state.children.length-1]=(0,_State.getInitialState)(newProps,scenes,state.index,newAction);return _extends({},state,{children:state.children});}case ActionConst.REFRESH:return props.base?_extends({navBar:state.navBar},scenes.rootProps,props,{key:state.key,from:null}):_extends({},state,props,{key:state.key,from:null});case ActionConst.PUSH_OR_POP:ind=state.children.findIndex(function(el){return el.sceneKey===action.key;});if(ind!==-1){return _extends({},state,{index:ind,from:state.children[state.index],children:refreshTopChild(state.children.slice(0,ind+1),action.refresh)});}return _extends({},state,{index:state.index+1,from:null,children:[].concat(_toConsumableArray(state.children),[(0,_State.getInitialState)(props,scenes,state.index+1,action)])});case ActionConst.PUSH:if(state.children[state.index].sceneKey===action.key&&!props.clone&&checkPropertiesEqual(action,state.children[state.index])){return state;}return _extends({},state,{index:state.index+1,from:null,children:[].concat(_toConsumableArray(state.children),[(0,_State.getInitialState)(props,scenes,state.index+1,action)])});case ActionConst.JUMP:{(0,_Util.assert)(state.tabs,'Parent='+state.key+' is not tab bar, jump action is not valid');ind=-1;state.children.forEach(function(c,i){if(c.sceneKey===action.key){ind=i;}});(0,_Util.assert)(ind!==-1,'Cannot find route with key='+action.key+' for parent='+state.key);if(action.unmountScenes){resetHistoryStack(state.children[ind]);}state.children[ind]=(0,_State.getInitialState)(props,scenes,state.index,action);return _extends({},state,{index:ind});}case ActionConst.REPLACE:if(state.children[state.index].sceneKey===action.key){return state;}state.children[state.children.length-1]=(0,_State.getInitialState)(props,scenes,state.index,action);return _extends({},state,{children:state.children});case ActionConst.RESET:if(state.children[state.index].sceneKey===action.key){return state;}state.children=state.children.splice(0,1);state.children[0]=(0,_State.getInitialState)(props,scenes,state.index,action);return _extends({},state,{index:0,from:null,children:state.children});default:return state;}}function findElement(state,key,type){if(_Actions.ActionMap[type]===ActionConst.REFRESH&&state.key===key||state.sceneKey===key){return state;}if(state.children){for(var _iterator2=state.children,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==='function'?Symbol.iterator:'@@iterator']();;){var _ref2;if(_isArray2){if(_i2>=_iterator2.length)break;_ref2=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref2=_i2.value;}var child=_ref2;var current=findElement(child,key,type);if(current)return current;}}return null;}function getCurrent(state){
if(!state.children){
return state;
}
return getCurrent(state.children[state.index]);
}

function update(state,action){

var props=_extends({},state.scenes[action.key],action);
(0,_Util.assert)(props.parent,'No parent is defined for route='+action.key);
return inject(state,action,props,state.scenes);
}

function reducer(_ref3){var initialState=_ref3.initialState,scenes=_ref3.scenes;
(0,_Util.assert)(initialState,'initialState should not be null');
(0,_Util.assert)(initialState.key,'initialState.key should not be null');
(0,_Util.assert)(scenes,'scenes should not be null');
return function(stateParam,actionParam){
var state=stateParam;
var action=actionParam;
state=state||_extends({},initialState,{scenes:scenes});
(0,_Util.assert)(action,'action should be defined');
(0,_Util.assert)(action.type,'action type should be defined');
(0,_Util.assert)(state.scenes,'state.scenes is missed');

if(action.key){
if(_Actions.ActionMap[action.type]===ActionConst.REFRESH){
var key=action.key;
var child=findElement(state,key,action.type)||state.scenes[key];
var sceneKey=child.sceneKey;
if(child.base){
child=_extends({},state.scenes[child.base],child);
(0,_Util.assert)(state.scenes[child.base],'No scene exists for base='+child.base);
key=state.scenes[child.base].key;
sceneKey=state.scenes[child.base].sceneKey;
}
(0,_Util.assert)(child,'missed child data for key='+key);

var evaluated={};
Object.keys(action).forEach(function(el){
if(typeof action[el]==='function'&&typeof child[el]!=='undefined'&&
typeof child[el]!==typeof action[el]){
evaluated[el]=action[el](child[el],child);
}
});
action=_extends({},child,action,evaluated,{sceneKey:sceneKey,key:key});


}else{
var scene=state.scenes[action.key];
(0,_Util.assert)(scene,'missed route data for key='+action.key);

if(scene.clone){
action.parent=getCurrent(state).parent;
}
}
}else{

if(_Actions.ActionMap[action.type]===ActionConst.BACK_ACTION||
_Actions.ActionMap[action.type]===ActionConst.BACK||
_Actions.ActionMap[action.type]===ActionConst.ANDROID_BACK||
_Actions.ActionMap[action.type]===ActionConst.POP_AND_REPLACE||
_Actions.ActionMap[action.type]===ActionConst.REFRESH||
_Actions.ActionMap[action.type]===ActionConst.POP_TO){
if(!action.key&&!action.parent){
action=_extends({},getCurrent(state),action);
}
}


if(_Actions.ActionMap[action.type]===ActionConst.POP_TO){





var target=action.data||action.scene;
(0,_Util.assert)(target,'PopTo() must be called with a single argument: '+
'either the scene name (string) or an object with within the scene property '+
'carrying the target scene to pop to');

var targetEl=findElement(state,target,action.type);
(0,_Util.assert)(targetEl,'Cannot find element name named '+target+' within current state');


var parent=targetEl.sceneKey;
var targetIndex=0;


if(!targetEl.children){
var targetParent=findElement(state,targetEl.parent,action.type);
(0,_Util.assert)(targetParent,'Cannot find parent for target '+target);
parent=targetParent.sceneKey;

targetIndex=targetParent.children.indexOf(targetEl);
(0,_Util.assert)(targetIndex>-1,target+' does not belong to '+targetParent.sceneKey);
}

action.parent=parent;
action.targetIndex=targetIndex;
}


if(_Actions.ActionMap[action.type]===ActionConst.BACK_ACTION||
_Actions.ActionMap[action.type]===ActionConst.BACK||
_Actions.ActionMap[action.type]===ActionConst.ANDROID_BACK||
_Actions.ActionMap[action.type]===ActionConst.POP_AND_REPLACE){
var _parent=action.parent||state.scenes[action.key].parent;
var el=findElement(state,_parent,action.type);
while(el.parent&&(el.children.length<=1||el.tabs)){
el=findElement(state,el.parent,action.type);
(0,_Util.assert)(el,'Cannot find element for parent='+el.parent+' within current state');
}
action.parent=el.sceneKey;
}
}

switch(_Actions.ActionMap[action.type]){
case ActionConst.BACK:
case ActionConst.BACK_ACTION:
case ActionConst.POP_AND_REPLACE:
case ActionConst.POP_TO:
case ActionConst.REFRESH:
case ActionConst.PUSH:
case ActionConst.PUSH_OR_POP:
case ActionConst.JUMP:
case ActionConst.REPLACE:
case ActionConst.RESET:
case ActionConst.ANDROID_BACK:
return update(state,action);

default:
return state;}


};
}exports.default=

reducer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlZHVjZXIuanMiXSwibmFtZXMiOlsiZmluZEVsZW1lbnQiLCJnZXRDdXJyZW50IiwiQWN0aW9uQ29uc3QiLCJjaGVja1Byb3BlcnRpZXNFcXVhbCIsImFjdGlvbiIsImxhc3RBY3Rpb24iLCJpc0VxdWFsIiwiT2JqZWN0Iiwia2V5cyIsImtleSIsImluZGV4T2YiLCJyZXNldEhpc3RvcnlTdGFjayIsImNoaWxkIiwibmV3Q2hpbGQiLCJpbmRleCIsImNoaWxkcmVuIiwibWFwIiwiZWwiLCJpIiwiaW5pdGlhbCIsInRhYnMiLCJyZWZyZXNoVG9wQ2hpbGQiLCJyZWZyZXNoIiwidG9wQ2hpbGQiLCJsZW5ndGgiLCJzbGljZSIsImluamVjdCIsInN0YXRlIiwicHJvcHMiLCJzY2VuZXMiLCJjb25kaXRpb24iLCJ0eXBlIiwiUkVGUkVTSCIsInNjZW5lS2V5IiwicGFyZW50IiwicmVzIiwiY2hhbmdlZCIsImNoYW5nZWRJbmRleCIsImluZCIsIlBPUF9UTyIsInRhcmdldEluZGV4IiwiQkFDSyIsIkJBQ0tfQUNUSU9OIiwicG9wTnVtIiwiZnJvbSIsIkFORFJPSURfQkFDSyIsIk9TIiwiUE9QX0FORF9SRVBMQUNFIiwibmV3QWN0aW9uIiwiZHVyYXRpb24iLCJuZXdQcm9wcyIsImJhc2UiLCJuYXZCYXIiLCJyb290UHJvcHMiLCJQVVNIX09SX1BPUCIsImZpbmRJbmRleCIsIlBVU0giLCJjbG9uZSIsIkpVTVAiLCJmb3JFYWNoIiwiYyIsInVubW91bnRTY2VuZXMiLCJSRVBMQUNFIiwiUkVTRVQiLCJzcGxpY2UiLCJjdXJyZW50IiwidXBkYXRlIiwicmVkdWNlciIsImluaXRpYWxTdGF0ZSIsInN0YXRlUGFyYW0iLCJhY3Rpb25QYXJhbSIsImV2YWx1YXRlZCIsInNjZW5lIiwidGFyZ2V0IiwiZGF0YSIsInRhcmdldEVsIiwidGFyZ2V0UGFyZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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QUFuQjtBQUNEO0FBQ0Y7O0FBRUQsT0FBUSxtQkFBVTdCLE9BQU8yQixJQUFqQixDQUFSO0FBQ0UsSUFBSzdCLGFBQVl1QyxJQUFqQjtBQUNBLElBQUt2QyxhQUFZd0MsV0FBakI7QUFDQSxJQUFLeEMsYUFBWTZDLGVBQWpCO0FBQ0EsSUFBSzdDLGFBQVlxQyxNQUFqQjtBQUNBLElBQUtyQyxhQUFZOEIsT0FBakI7QUFDQSxJQUFLOUIsYUFBWXNELElBQWpCO0FBQ0EsSUFBS3RELGFBQVlvRCxXQUFqQjtBQUNBLElBQUtwRCxhQUFZd0QsSUFBakI7QUFDQSxJQUFLeEQsYUFBWTRELE9BQWpCO0FBQ0EsSUFBSzVELGFBQVk2RCxLQUFqQjtBQUNBLElBQUs3RCxhQUFZMkMsWUFBakI7QUFDRSxNQUFPcUIsUUFBT3ZDLEtBQVAsQ0FBY3ZCLE1BQWQsQ0FBUDs7QUFFRjtBQUNFLE1BQU91QixNQUFQLENBZko7OztBQWtCRCxDQXRIRDtBQXVIRCxDOztBQUVjd0MsTyIsImZpbGUiOiJSZWR1Y2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgUGF2ZWwgQWtzb25vdlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKi9cblxuLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cblxuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdyZWFjdC1uYXRpdmUnO1xuaW1wb3J0ICogYXMgQWN0aW9uQ29uc3QgZnJvbSAnLi9BY3Rpb25Db25zdCc7XG5pbXBvcnQgeyBBY3Rpb25NYXAgfSBmcm9tICcuL0FjdGlvbnMnO1xuaW1wb3J0IHsgYXNzZXJ0IH0gZnJvbSAnLi9VdGlsJztcbmltcG9ydCB7IGdldEluaXRpYWxTdGF0ZSB9IGZyb20gJy4vU3RhdGUnO1xuXG4vLyBXQVJOOiBpdCBpcyBub3Qgd29ya2luZyBjb3JyZWN0LiByZXdyaXRlIGl0LlxuZnVuY3Rpb24gY2hlY2tQcm9wZXJ0aWVzRXF1YWwoYWN0aW9uLCBsYXN0QWN0aW9uKSB7XG4gIGxldCBpc0VxdWFsID0gdHJ1ZTtcbiAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoYWN0aW9uKSkge1xuICAgIGlmIChbJ2tleScsICd0eXBlJywgJ3BhcmVudCddLmluZGV4T2Yoa2V5KSA9PT0gLTEpIHtcbiAgICAgIGlmIChhY3Rpb25ba2V5XSAhPT0gbGFzdEFjdGlvbltrZXldKSB7XG4gICAgICAgIGlzRXF1YWwgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIGlzRXF1YWw7XG59XG5cbmZ1bmN0aW9uIHJlc2V0SGlzdG9yeVN0YWNrKGNoaWxkKSB7XG4gIGNvbnN0IG5ld0NoaWxkID0gY2hpbGQ7XG4gIG5ld0NoaWxkLmluZGV4ID0gMDtcbiAgY2hpbGQuY2hpbGRyZW4ubWFwKFxuICAgIChlbCwgaSkgPT4ge1xuICAgICAgaWYgKGVsLmluaXRpYWwpIHtcbiAgICAgICAgbmV3Q2hpbGQuaW5kZXggPSBpO1xuICAgICAgICBpZiAoIW5ld0NoaWxkLnRhYnMpIHtcbiAgICAgICAgICBuZXdDaGlsZC5jaGlsZHJlbiA9IFtlbF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChlbC5jaGlsZHJlbikge1xuICAgICAgICByZXNldEhpc3RvcnlTdGFjayhlbCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gbmV3Q2hpbGQ7XG4gICAgfSxcbiAgKTtcbn1cblxuZnVuY3Rpb24gcmVmcmVzaFRvcENoaWxkKGNoaWxkcmVuLCByZWZyZXNoKSB7XG4gIGlmIChyZWZyZXNoKSB7XG4gICAgY29uc3QgdG9wQ2hpbGQgPSBjaGlsZHJlbltjaGlsZHJlbi5sZW5ndGggLSAxXTtcbiAgICByZXR1cm4gWy4uLmNoaWxkcmVuLnNsaWNlKDAsIC0xKSwgeyAuLi50b3BDaGlsZCwgLi4ucmVmcmVzaCB9XTtcbiAgfVxuICByZXR1cm4gY2hpbGRyZW47XG59XG5cbmZ1bmN0aW9uIGluamVjdChzdGF0ZSwgYWN0aW9uLCBwcm9wcywgc2NlbmVzKSB7XG4gIGNvbnN0IGNvbmRpdGlvbiA9IEFjdGlvbk1hcFthY3Rpb24udHlwZV0gPT09IEFjdGlvbkNvbnN0LlJFRlJFU0ggPyBzdGF0ZS5rZXkgPT09IHByb3BzLmtleSB8fFxuICBzdGF0ZS5zY2VuZUtleSA9PT0gYWN0aW9uLmtleSA6IHN0YXRlLnNjZW5lS2V5ID09PSBwcm9wcy5wYXJlbnQ7XG4gIC8vIGNvbnNvbGUubG9nKFwiSU5KRUNUOlwiLCBhY3Rpb24ua2V5LCBzdGF0ZS5zY2VuZUtleSwgY29uZGl0aW9uKTtcbiAgaWYgKCFjb25kaXRpb24pIHtcbiAgICBpZiAoc3RhdGUuY2hpbGRyZW4pIHtcbiAgICAgIGNvbnN0IHJlcyA9IHN0YXRlLmNoaWxkcmVuLm1hcChlbCA9PiBpbmplY3QoZWwsIGFjdGlvbiwgcHJvcHMsIHNjZW5lcykpO1xuICAgICAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcbiAgICAgIGxldCBjaGFuZ2VkSW5kZXggPSAtMTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGlmIChyZXNbaV0gIT09IHN0YXRlLmNoaWxkcmVuW2ldKSB7XG4gICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgICAgY2hhbmdlZEluZGV4ID0gaTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGNoYW5nZWQgPyB7IC4uLnN0YXRlLCBjaGlsZHJlbjogcmVzLCBpbmRleDogY2hhbmdlZEluZGV4IH0gOiBzdGF0ZTtcbiAgICB9XG4gICAgcmV0dXJuIHN0YXRlO1xuICB9XG4gIGxldCBpbmQ7XG5cbiAgc3dpdGNoIChBY3Rpb25NYXBbYWN0aW9uLnR5cGVdKSB7XG4gICAgY2FzZSBBY3Rpb25Db25zdC5QT1BfVE86IHtcbiAgICAgIGNvbnN0IHRhcmdldEluZGV4ID0gYWN0aW9uLnRhcmdldEluZGV4O1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgaW5kZXg6IHRhcmdldEluZGV4LFxuICAgICAgICBjaGlsZHJlbjogcmVmcmVzaFRvcENoaWxkKHN0YXRlLmNoaWxkcmVuLnNsaWNlKDAsICh0YXJnZXRJbmRleCArIDEpKSwgYWN0aW9uLnJlZnJlc2gpLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjYXNlIEFjdGlvbkNvbnN0LkJBQ0s6XG4gICAgY2FzZSBBY3Rpb25Db25zdC5CQUNLX0FDVElPTjoge1xuICAgICAgYXNzZXJ0KCFzdGF0ZS50YWJzLCAncG9wKCkgb3BlcmF0aW9uIGNhbm5vdCBiZSBydW4gb24gdGFiIGJhciAodGFicz10cnVlKScpO1xuXG4gICAgICBpZiAoc3RhdGUuaW5kZXggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xuICAgICAgfVxuXG4gICAgICBsZXQgcG9wTnVtID0gMTtcbiAgICAgIGlmIChhY3Rpb24ucG9wTnVtKSB7XG4gICAgICAgIGFzc2VydCh0eXBlb2YgKGFjdGlvbi5wb3BOdW0pID09PSAnbnVtYmVyJyxcbiAgICAgICAgICAnVGhlIGRhdGEgaXMgdGhlIG51bWJlciBvZiBzY2VuZXMgeW91IHdhbnQgdG8gcG9wLCBpdCBtdXN0IGJlIE51bWJlcicpO1xuICAgICAgICBwb3BOdW0gPSBhY3Rpb24ucG9wTnVtO1xuICAgICAgICBhc3NlcnQocG9wTnVtICUgMSA9PT0gMCxcbiAgICAgICAgICAnVGhlIGRhdGEgaXMgdGhlIG51bWJlciBvZiBzY2VuZXMgeW91IHdhbnQgdG8gcG9wLCBpdCBtdXN0IGJlIGludGVnZXIuJyk7XG4gICAgICAgIGFzc2VydChwb3BOdW0gPiAxLFxuICAgICAgICAgICdUaGUgZGF0YSBpcyB0aGUgbnVtYmVyIG9mIHNjZW5lcyB5b3Ugd2FudCB0byBwb3AsIGl0IG11c3QgYmUgYmlnZ2VyIHRoYW4gMS4nKTtcbiAgICAgICAgYXNzZXJ0KHBvcE51bSA8PSBzdGF0ZS5pbmRleCxcbiAgICAgICAgICAnVGhlIGRhdGEgaXMgdGhlIG51bWJlciBvZiBzY2VuZXMgeW91IHdhbnQgdG8gcG9wLCAnICtcbiAgICAgICAgICBcIml0IG11c3QgYmUgc21hbGxlciB0aGFuIHNjZW5lcyBzdGFjaydzIGxlbmd0aC5cIik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBpbmRleDogc3RhdGUuaW5kZXggLSBwb3BOdW0sXG4gICAgICAgIGZyb206IHN0YXRlLmNoaWxkcmVuW3N0YXRlLmNoaWxkcmVuLmxlbmd0aCAtIHBvcE51bV0sXG4gICAgICAgIGNoaWxkcmVuOiByZWZyZXNoVG9wQ2hpbGQoc3RhdGUuY2hpbGRyZW4uc2xpY2UoMCwgLTEgKiBwb3BOdW0pLCBhY3Rpb24ucmVmcmVzaCksXG4gICAgICB9O1xuICAgIH1cbiAgICBjYXNlIEFjdGlvbkNvbnN0LkFORFJPSURfQkFDSzoge1xuICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHtcbiAgICAgICAgYXNzZXJ0KHN0YXRlLmluZGV4ID4gMCwgJ1lvdSBhcmUgYWxyZWFkeSBpbiB0aGUgcm9vdCBzY2VuZS4nKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGluZGV4OiBzdGF0ZS5pbmRleCAtIDEsXG4gICAgICAgIGZyb206IHN0YXRlLmNoaWxkcmVuW3N0YXRlLmNoaWxkcmVuLmxlbmd0aCAtIDFdLFxuICAgICAgICBjaGlsZHJlbjogcmVmcmVzaFRvcENoaWxkKHN0YXRlLmNoaWxkcmVuLnNsaWNlKDAsIC0xKSwgYWN0aW9uLnJlZnJlc2gpLFxuICAgICAgfTtcbiAgICB9XG4gICAgLy8gVGhpcyBhY3Rpb24gd2lsbCBwb3AgdGhlIHNjZW5lIHN0YWNrIGFuZCB0aGVuIHJlcGxhY2UgY3VycmVudCBzY2VuZSBpbiBvbmUgZ29cbiAgICBjYXNlIEFjdGlvbkNvbnN0LlBPUF9BTkRfUkVQTEFDRToge1xuICAgICAgYXNzZXJ0KCFzdGF0ZS50YWJzLCAncG9wKCkgb3BlcmF0aW9uIGNhbm5vdCBiZSBydW4gb24gdGFiIGJhciAodGFicz10cnVlKScpO1xuICAgICAgYXNzZXJ0KHN0YXRlLmluZGV4ID4gMCwgJ1lvdSBhcmUgYWxyZWFkeSBpbiB0aGUgcm9vdCBzY2VuZS4nKTtcblxuICAgICAgbGV0IHBvcE51bSA9IDE7XG4gICAgICBpZiAoYWN0aW9uLnBvcE51bSkge1xuICAgICAgICBhc3NlcnQodHlwZW9mIChhY3Rpb24ucG9wTnVtKSA9PT0gJ251bWJlcicsXG4gICAgICAgICAgJ1RoZSBkYXRhIGlzIHRoZSBudW1iZXIgb2Ygc2NlbmVzIHlvdSB3YW50IHRvIHBvcCwgaXQgbXVzdCBiZSBOdW1iZXInKTtcbiAgICAgICAgcG9wTnVtID0gYWN0aW9uLnBvcE51bTtcbiAgICAgICAgYXNzZXJ0KHBvcE51bSAlIDEgPT09IDAsXG4gICAgICAgICAgJ1RoZSBkYXRhIGlzIHRoZSBudW1iZXIgb2Ygc2NlbmVzIHlvdSB3YW50IHRvIHBvcCwgaXQgbXVzdCBiZSBpbnRlZ2VyLicpO1xuICAgICAgICBhc3NlcnQocG9wTnVtID4gMSxcbiAgICAgICAgICAnVGhlIGRhdGEgaXMgdGhlIG51bWJlciBvZiBzY2VuZXMgeW91IHdhbnQgdG8gcG9wLCBpdCBtdXN0IGJlIGJpZ2dlciB0aGFuIDEuJyk7XG4gICAgICAgIGFzc2VydChwb3BOdW0gPD0gc3RhdGUuaW5kZXgsXG4gICAgICAgICAgJ1RoZSBkYXRhIGlzIHRoZSBudW1iZXIgb2Ygc2NlbmVzIHlvdSB3YW50IHRvIHBvcCwgJyArXG4gICAgICAgICAgXCJpdCBtdXN0IGJlIHNtYWxsZXIgdGhhbiBzY2VuZXMgc3RhY2sncyBsZW5ndGguXCIpO1xuICAgICAgfVxuXG4gICAgICBzdGF0ZSA9IHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGluZGV4OiBzdGF0ZS5pbmRleCAtIHBvcE51bSxcbiAgICAgICAgZnJvbTogc3RhdGUuY2hpbGRyZW5bc3RhdGUuY2hpbGRyZW4ubGVuZ3RoIC0gcG9wTnVtXSxcbiAgICAgICAgY2hpbGRyZW46IHN0YXRlLmNoaWxkcmVuLnNsaWNlKDAsIC0xICogcG9wTnVtKSxcbiAgICAgIH07XG5cbiAgICAgIGlmIChzdGF0ZS5jaGlsZHJlbltzdGF0ZS5pbmRleF0uc2NlbmVLZXkgPT09IGFjdGlvbi5rZXkpIHtcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBuZXdBY3Rpb24gPSB7XG4gICAgICAgIGR1cmF0aW9uOiAwLCAgLy8gZG8gbm90IGFuaW1hdGVcbiAgICAgICAgLi4uYWN0aW9uLFxuICAgICAgfTtcbiAgICAgIGRlbGV0ZSBuZXdBY3Rpb24ucG9wTnVtO1xuXG4gICAgICBjb25zdCBuZXdQcm9wcyA9IHsgLi4ucHJvcHMgfTtcbiAgICAgIGRlbGV0ZSBuZXdQcm9wcy5wb3BOdW07XG5cbiAgICAgIHN0YXRlLmNoaWxkcmVuW3N0YXRlLmNoaWxkcmVuLmxlbmd0aCAtIDFdID0gZ2V0SW5pdGlhbFN0YXRlKFxuICAgICAgICBuZXdQcm9wcyxcbiAgICAgICAgc2NlbmVzLFxuICAgICAgICBzdGF0ZS5pbmRleCxcbiAgICAgICAgbmV3QWN0aW9uLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHsgLi4uc3RhdGUsIGNoaWxkcmVuOiBzdGF0ZS5jaGlsZHJlbiB9O1xuICAgIH1cbiAgICBjYXNlIEFjdGlvbkNvbnN0LlJFRlJFU0g6XG4gICAgICByZXR1cm4gcHJvcHMuYmFzZSA/IHtcbiAgICAgICAgbmF2QmFyOiBzdGF0ZS5uYXZCYXIsXG4gICAgICAgIC4uLnNjZW5lcy5yb290UHJvcHMsXG4gICAgICAgIC4uLnByb3BzLFxuICAgICAgICBrZXk6IHN0YXRlLmtleSxcbiAgICAgICAgZnJvbTogbnVsbCB9XG4gICAgICA6IHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIC4uLnByb3BzLFxuICAgICAgICBrZXk6IHN0YXRlLmtleSxcbiAgICAgICAgZnJvbTogbnVsbCxcbiAgICAgIH07XG4gICAgY2FzZSBBY3Rpb25Db25zdC5QVVNIX09SX1BPUDpcbiAgICAgIGluZCA9IHN0YXRlLmNoaWxkcmVuLmZpbmRJbmRleChlbCA9PiBlbC5zY2VuZUtleSA9PT0gYWN0aW9uLmtleSk7XG4gICAgICBpZiAoaW5kICE9PSAtMSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLnN0YXRlLFxuICAgICAgICAgIGluZGV4OiBpbmQsXG4gICAgICAgICAgZnJvbTogc3RhdGUuY2hpbGRyZW5bc3RhdGUuaW5kZXhdLFxuICAgICAgICAgIGNoaWxkcmVuOiByZWZyZXNoVG9wQ2hpbGQoc3RhdGUuY2hpbGRyZW4uc2xpY2UoMCwgaW5kICsgMSksIGFjdGlvbi5yZWZyZXNoKSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBpbmRleDogc3RhdGUuaW5kZXggKyAxLFxuICAgICAgICBmcm9tOiBudWxsLFxuICAgICAgICBjaGlsZHJlbjogWy4uLnN0YXRlLmNoaWxkcmVuLCBnZXRJbml0aWFsU3RhdGUocHJvcHMsIHNjZW5lcywgc3RhdGUuaW5kZXggKyAxLCBhY3Rpb24pXSxcbiAgICAgIH07XG4gICAgY2FzZSBBY3Rpb25Db25zdC5QVVNIOlxuICAgICAgaWYgKHN0YXRlLmNoaWxkcmVuW3N0YXRlLmluZGV4XS5zY2VuZUtleSA9PT0gYWN0aW9uLmtleSAmJiAhcHJvcHMuY2xvbmVcbiAgICAgICAgJiYgY2hlY2tQcm9wZXJ0aWVzRXF1YWwoYWN0aW9uLCBzdGF0ZS5jaGlsZHJlbltzdGF0ZS5pbmRleF0pKSB7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBpbmRleDogc3RhdGUuaW5kZXggKyAxLFxuICAgICAgICBmcm9tOiBudWxsLFxuICAgICAgICBjaGlsZHJlbjogWy4uLnN0YXRlLmNoaWxkcmVuLCBnZXRJbml0aWFsU3RhdGUocHJvcHMsIHNjZW5lcywgc3RhdGUuaW5kZXggKyAxLCBhY3Rpb24pXSxcbiAgICAgIH07XG4gICAgY2FzZSBBY3Rpb25Db25zdC5KVU1QOiB7XG4gICAgICBhc3NlcnQoc3RhdGUudGFicywgYFBhcmVudD0ke3N0YXRlLmtleX0gaXMgbm90IHRhYiBiYXIsIGp1bXAgYWN0aW9uIGlzIG5vdCB2YWxpZGApO1xuICAgICAgaW5kID0gLTE7XG4gICAgICBzdGF0ZS5jaGlsZHJlbi5mb3JFYWNoKChjLCBpKSA9PiB7IGlmIChjLnNjZW5lS2V5ID09PSBhY3Rpb24ua2V5KSB7IGluZCA9IGk7IH0gfSk7XG4gICAgICBhc3NlcnQoaW5kICE9PSAtMSwgYENhbm5vdCBmaW5kIHJvdXRlIHdpdGgga2V5PSR7YWN0aW9uLmtleX0gZm9yIHBhcmVudD0ke3N0YXRlLmtleX1gKTtcblxuICAgICAgaWYgKGFjdGlvbi51bm1vdW50U2NlbmVzKSB7XG4gICAgICAgIHJlc2V0SGlzdG9yeVN0YWNrKHN0YXRlLmNoaWxkcmVuW2luZF0pO1xuICAgICAgfVxuXG4gICAgICBzdGF0ZS5jaGlsZHJlbltpbmRdID0gZ2V0SW5pdGlhbFN0YXRlKFxuICAgICAgICBwcm9wcyxcbiAgICAgICAgc2NlbmVzLFxuICAgICAgICBzdGF0ZS5pbmRleCxcbiAgICAgICAgYWN0aW9uLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHsgLi4uc3RhdGUsIGluZGV4OiBpbmQgfTtcbiAgICB9XG4gICAgY2FzZSBBY3Rpb25Db25zdC5SRVBMQUNFOlxuICAgICAgaWYgKHN0YXRlLmNoaWxkcmVuW3N0YXRlLmluZGV4XS5zY2VuZUtleSA9PT0gYWN0aW9uLmtleSkge1xuICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgICB9XG5cbiAgICAgIHN0YXRlLmNoaWxkcmVuW3N0YXRlLmNoaWxkcmVuLmxlbmd0aCAtIDFdID0gZ2V0SW5pdGlhbFN0YXRlKFxuICAgICAgICBwcm9wcyxcbiAgICAgICAgc2NlbmVzLFxuICAgICAgICBzdGF0ZS5pbmRleCxcbiAgICAgICAgYWN0aW9uLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHsgLi4uc3RhdGUsIGNoaWxkcmVuOiBzdGF0ZS5jaGlsZHJlbiB9O1xuICAgIGNhc2UgQWN0aW9uQ29uc3QuUkVTRVQ6XG4gICAgICBpZiAoc3RhdGUuY2hpbGRyZW5bc3RhdGUuaW5kZXhdLnNjZW5lS2V5ID09PSBhY3Rpb24ua2V5KSB7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgIH1cblxuICAgICAgc3RhdGUuY2hpbGRyZW4gPSBzdGF0ZS5jaGlsZHJlbi5zcGxpY2UoMCwgMSk7XG4gICAgICBzdGF0ZS5jaGlsZHJlblswXSA9IGdldEluaXRpYWxTdGF0ZShwcm9wcywgc2NlbmVzLCBzdGF0ZS5pbmRleCwgYWN0aW9uKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGluZGV4OiAwLFxuICAgICAgICBmcm9tOiBudWxsLFxuICAgICAgICBjaGlsZHJlbjogc3RhdGUuY2hpbGRyZW4sXG4gICAgICB9O1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gc3RhdGU7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRFbGVtZW50KHN0YXRlLCBrZXksIHR5cGUpIHtcbiAgaWYgKChBY3Rpb25NYXBbdHlwZV0gPT09IEFjdGlvbkNvbnN0LlJFRlJFU0ggJiYgc3RhdGUua2V5ID09PSBrZXkpIHx8IHN0YXRlLnNjZW5lS2V5ID09PSBrZXkpIHtcbiAgICByZXR1cm4gc3RhdGU7XG4gIH1cbiAgaWYgKHN0YXRlLmNoaWxkcmVuKSB7XG4gICAgZm9yIChjb25zdCBjaGlsZCBvZiBzdGF0ZS5jaGlsZHJlbikge1xuICAgICAgY29uc3QgY3VycmVudCA9IGZpbmRFbGVtZW50KGNoaWxkLCBrZXksIHR5cGUpO1xuICAgICAgaWYgKGN1cnJlbnQpIHJldHVybiBjdXJyZW50O1xuICAgIH1cbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEN1cnJlbnQoc3RhdGUpIHtcbiAgaWYgKCFzdGF0ZS5jaGlsZHJlbikge1xuICAgIHJldHVybiBzdGF0ZTtcbiAgfVxuICByZXR1cm4gZ2V0Q3VycmVudChzdGF0ZS5jaGlsZHJlbltzdGF0ZS5pbmRleF0pO1xufVxuXG5mdW5jdGlvbiB1cGRhdGUoc3RhdGUsIGFjdGlvbikge1xuICAvLyBmaW5kIHBhcmVudCBpbiB0aGUgc3RhdGVcbiAgY29uc3QgcHJvcHMgPSB7IC4uLnN0YXRlLnNjZW5lc1thY3Rpb24ua2V5XSwgLi4uYWN0aW9uIH07XG4gIGFzc2VydChwcm9wcy5wYXJlbnQsIGBObyBwYXJlbnQgaXMgZGVmaW5lZCBmb3Igcm91dGU9JHthY3Rpb24ua2V5fWApO1xuICByZXR1cm4gaW5qZWN0KHN0YXRlLCBhY3Rpb24sIHByb3BzLCBzdGF0ZS5zY2VuZXMpO1xufVxuXG5mdW5jdGlvbiByZWR1Y2VyKHsgaW5pdGlhbFN0YXRlLCBzY2VuZXMgfSkge1xuICBhc3NlcnQoaW5pdGlhbFN0YXRlLCAnaW5pdGlhbFN0YXRlIHNob3VsZCBub3QgYmUgbnVsbCcpO1xuICBhc3NlcnQoaW5pdGlhbFN0YXRlLmtleSwgJ2luaXRpYWxTdGF0ZS5rZXkgc2hvdWxkIG5vdCBiZSBudWxsJyk7XG4gIGFzc2VydChzY2VuZXMsICdzY2VuZXMgc2hvdWxkIG5vdCBiZSBudWxsJyk7XG4gIHJldHVybiAoc3RhdGVQYXJhbSwgYWN0aW9uUGFyYW0pID0+IHtcbiAgICBsZXQgc3RhdGUgPSBzdGF0ZVBhcmFtO1xuICAgIGxldCBhY3Rpb24gPSBhY3Rpb25QYXJhbTtcbiAgICBzdGF0ZSA9IHN0YXRlIHx8IHsgLi4uaW5pdGlhbFN0YXRlLCBzY2VuZXMgfTtcbiAgICBhc3NlcnQoYWN0aW9uLCAnYWN0aW9uIHNob3VsZCBiZSBkZWZpbmVkJyk7XG4gICAgYXNzZXJ0KGFjdGlvbi50eXBlLCAnYWN0aW9uIHR5cGUgc2hvdWxkIGJlIGRlZmluZWQnKTtcbiAgICBhc3NlcnQoc3RhdGUuc2NlbmVzLCAnc3RhdGUuc2NlbmVzIGlzIG1pc3NlZCcpO1xuXG4gICAgaWYgKGFjdGlvbi5rZXkpIHtcbiAgICAgIGlmIChBY3Rpb25NYXBbYWN0aW9uLnR5cGVdID09PSBBY3Rpb25Db25zdC5SRUZSRVNIKSB7XG4gICAgICAgIGxldCBrZXkgPSBhY3Rpb24ua2V5O1xuICAgICAgICBsZXQgY2hpbGQgPSBmaW5kRWxlbWVudChzdGF0ZSwga2V5LCBhY3Rpb24udHlwZSkgfHwgc3RhdGUuc2NlbmVzW2tleV07XG4gICAgICAgIGxldCBzY2VuZUtleSA9IGNoaWxkLnNjZW5lS2V5O1xuICAgICAgICBpZiAoY2hpbGQuYmFzZSkge1xuICAgICAgICAgIGNoaWxkID0geyAuLi5zdGF0ZS5zY2VuZXNbY2hpbGQuYmFzZV0sIC4uLmNoaWxkIH07XG4gICAgICAgICAgYXNzZXJ0KHN0YXRlLnNjZW5lc1tjaGlsZC5iYXNlXSwgYE5vIHNjZW5lIGV4aXN0cyBmb3IgYmFzZT0ke2NoaWxkLmJhc2V9YCk7XG4gICAgICAgICAga2V5ID0gc3RhdGUuc2NlbmVzW2NoaWxkLmJhc2VdLmtleTtcbiAgICAgICAgICBzY2VuZUtleSA9IHN0YXRlLnNjZW5lc1tjaGlsZC5iYXNlXS5zY2VuZUtleTtcbiAgICAgICAgfVxuICAgICAgICBhc3NlcnQoY2hpbGQsIGBtaXNzZWQgY2hpbGQgZGF0YSBmb3Iga2V5PSR7a2V5fWApO1xuICAgICAgICAvLyBldmFsdWF0ZSBmdW5jdGlvbnMgd2l0aGluIGFjdGlvbnMgdG8gYWxsb3cgY29uZGl0aW9uYWwgc2V0LCBsaWtlIHN3aXRjaCB2YWx1ZXNcbiAgICAgICAgY29uc3QgZXZhbHVhdGVkID0ge307XG4gICAgICAgIE9iamVjdC5rZXlzKGFjdGlvbikuZm9yRWFjaCgoZWwpID0+IHtcbiAgICAgICAgICBpZiAodHlwZW9mIGFjdGlvbltlbF0gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGNoaWxkW2VsXSAhPT0gJ3VuZGVmaW5lZCdcbiAgICAgICAgICAgICYmIHR5cGVvZiBjaGlsZFtlbF0gIT09IHR5cGVvZiBhY3Rpb25bZWxdKSB7XG4gICAgICAgICAgICBldmFsdWF0ZWRbZWxdID0gYWN0aW9uW2VsXShjaGlsZFtlbF0sIGNoaWxkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBhY3Rpb24gPSB7IC4uLmNoaWxkLCAuLi5hY3Rpb24sIC4uLmV2YWx1YXRlZCwgc2NlbmVLZXksIGtleSB9O1xuXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiUkVGUkVTSCBBQ1RJT046XCIsIGFjdGlvbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzY2VuZSA9IHN0YXRlLnNjZW5lc1thY3Rpb24ua2V5XTtcbiAgICAgICAgYXNzZXJ0KHNjZW5lLCBgbWlzc2VkIHJvdXRlIGRhdGEgZm9yIGtleT0ke2FjdGlvbi5rZXl9YCk7XG4gICAgICAgIC8vIGNsb25lIHNjZW5lXG4gICAgICAgIGlmIChzY2VuZS5jbG9uZSkge1xuICAgICAgICAgIGFjdGlvbi5wYXJlbnQgPSBnZXRDdXJyZW50KHN0YXRlKS5wYXJlbnQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gc2V0IGN1cnJlbnQgcm91dGUgZm9yIHBvcCBhY3Rpb24gb3IgcmVmcmVzaCBhY3Rpb25cbiAgICAgIGlmIChBY3Rpb25NYXBbYWN0aW9uLnR5cGVdID09PSBBY3Rpb25Db25zdC5CQUNLX0FDVElPTiB8fFxuICAgICAgICAgIEFjdGlvbk1hcFthY3Rpb24udHlwZV0gPT09IEFjdGlvbkNvbnN0LkJBQ0sgfHxcbiAgICAgICAgICBBY3Rpb25NYXBbYWN0aW9uLnR5cGVdID09PSBBY3Rpb25Db25zdC5BTkRST0lEX0JBQ0sgfHxcbiAgICAgICAgICBBY3Rpb25NYXBbYWN0aW9uLnR5cGVdID09PSBBY3Rpb25Db25zdC5QT1BfQU5EX1JFUExBQ0UgfHxcbiAgICAgICAgICBBY3Rpb25NYXBbYWN0aW9uLnR5cGVdID09PSBBY3Rpb25Db25zdC5SRUZSRVNIIHx8XG4gICAgICAgICAgQWN0aW9uTWFwW2FjdGlvbi50eXBlXSA9PT0gQWN0aW9uQ29uc3QuUE9QX1RPKSB7XG4gICAgICAgIGlmICghYWN0aW9uLmtleSAmJiAhYWN0aW9uLnBhcmVudCkge1xuICAgICAgICAgIGFjdGlvbiA9IHsgLi4uZ2V0Q3VycmVudChzdGF0ZSksIC4uLmFjdGlvbiB9O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEZpbmQgdGhlIHBhcmVudCBhbmQgaW5kZXggb2YgdGhlIGZ1dHVyZSBzdGF0ZVxuICAgICAgaWYgKEFjdGlvbk1hcFthY3Rpb24udHlwZV0gPT09IEFjdGlvbkNvbnN0LlBPUF9UTykge1xuICAgICAgICAvKlxuICAgICAgICAgKiBpZiBhIHN0cmluZyBpcyBwYXNzZWQgYXMgb25seSBhcmd1bWVudFxuICAgICAgICAgKiBBY3Rpb25zLmZpbHRlclBhcmFtIHdpbGwgcHV0IGl0IGluIHRoZSBkYXRhIHByb3BlcnR5XG4gICAgICAgICAqIG90aGVyd2lzZSBsb29rIGZvciB0aGUgc2NlbmUgcHJvcGVydHlcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IHRhcmdldCA9IGFjdGlvbi5kYXRhIHx8IGFjdGlvbi5zY2VuZTtcbiAgICAgICAgYXNzZXJ0KHRhcmdldCwgJ1BvcFRvKCkgbXVzdCBiZSBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudDogJyArXG4gICAgICAgICdlaXRoZXIgdGhlIHNjZW5lIG5hbWUgKHN0cmluZykgb3IgYW4gb2JqZWN0IHdpdGggd2l0aGluIHRoZSBzY2VuZSBwcm9wZXJ0eSAnICtcbiAgICAgICAgJ2NhcnJ5aW5nIHRoZSB0YXJnZXQgc2NlbmUgdG8gcG9wIHRvJyk7XG5cbiAgICAgICAgY29uc3QgdGFyZ2V0RWwgPSBmaW5kRWxlbWVudChzdGF0ZSwgdGFyZ2V0LCBhY3Rpb24udHlwZSk7XG4gICAgICAgIGFzc2VydCh0YXJnZXRFbCwgYENhbm5vdCBmaW5kIGVsZW1lbnQgbmFtZSBuYW1lZCAke3RhcmdldH0gd2l0aGluIGN1cnJlbnQgc3RhdGVgKTtcblxuICAgICAgICAvLyB0YXJnZXQgaXMgYSBub2RlXG4gICAgICAgIGxldCBwYXJlbnQgPSB0YXJnZXRFbC5zY2VuZUtleTtcbiAgICAgICAgbGV0IHRhcmdldEluZGV4ID0gMDtcblxuICAgICAgICAvLyB0YXJnZXQgaXMgY2hpbGQgb2YgYSBub2RlXG4gICAgICAgIGlmICghdGFyZ2V0RWwuY2hpbGRyZW4pIHtcbiAgICAgICAgICBjb25zdCB0YXJnZXRQYXJlbnQgPSBmaW5kRWxlbWVudChzdGF0ZSwgdGFyZ2V0RWwucGFyZW50LCBhY3Rpb24udHlwZSk7XG4gICAgICAgICAgYXNzZXJ0KHRhcmdldFBhcmVudCwgYENhbm5vdCBmaW5kIHBhcmVudCBmb3IgdGFyZ2V0ICR7dGFyZ2V0fWApO1xuICAgICAgICAgIHBhcmVudCA9IHRhcmdldFBhcmVudC5zY2VuZUtleTtcblxuICAgICAgICAgIHRhcmdldEluZGV4ID0gdGFyZ2V0UGFyZW50LmNoaWxkcmVuLmluZGV4T2YodGFyZ2V0RWwpO1xuICAgICAgICAgIGFzc2VydCh0YXJnZXRJbmRleCA+IC0xLCBgJHt0YXJnZXR9IGRvZXMgbm90IGJlbG9uZyB0byAke3RhcmdldFBhcmVudC5zY2VuZUtleX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFjdGlvbi5wYXJlbnQgPSBwYXJlbnQ7XG4gICAgICAgIGFjdGlvbi50YXJnZXRJbmRleCA9IHRhcmdldEluZGV4O1xuICAgICAgfVxuXG4gICAgICAvLyByZWN1cnNpdmUgcG9wIHBhcmVudFxuICAgICAgaWYgKEFjdGlvbk1hcFthY3Rpb24udHlwZV0gPT09IEFjdGlvbkNvbnN0LkJBQ0tfQUNUSU9OIHx8XG4gICAgICAgICAgQWN0aW9uTWFwW2FjdGlvbi50eXBlXSA9PT0gQWN0aW9uQ29uc3QuQkFDSyB8fFxuICAgICAgICAgIEFjdGlvbk1hcFthY3Rpb24udHlwZV0gPT09IEFjdGlvbkNvbnN0LkFORFJPSURfQkFDSyB8fFxuICAgICAgICAgIEFjdGlvbk1hcFthY3Rpb24udHlwZV0gPT09IEFjdGlvbkNvbnN0LlBPUF9BTkRfUkVQTEFDRSkge1xuICAgICAgICBjb25zdCBwYXJlbnQgPSBhY3Rpb24ucGFyZW50IHx8IHN0YXRlLnNjZW5lc1thY3Rpb24ua2V5XS5wYXJlbnQ7XG4gICAgICAgIGxldCBlbCA9IGZpbmRFbGVtZW50KHN0YXRlLCBwYXJlbnQsIGFjdGlvbi50eXBlKTtcbiAgICAgICAgd2hpbGUgKGVsLnBhcmVudCAmJiAoZWwuY2hpbGRyZW4ubGVuZ3RoIDw9IDEgfHwgZWwudGFicykpIHtcbiAgICAgICAgICBlbCA9IGZpbmRFbGVtZW50KHN0YXRlLCBlbC5wYXJlbnQsIGFjdGlvbi50eXBlKTtcbiAgICAgICAgICBhc3NlcnQoZWwsIGBDYW5ub3QgZmluZCBlbGVtZW50IGZvciBwYXJlbnQ9JHtlbC5wYXJlbnR9IHdpdGhpbiBjdXJyZW50IHN0YXRlYCk7XG4gICAgICAgIH1cbiAgICAgICAgYWN0aW9uLnBhcmVudCA9IGVsLnNjZW5lS2V5O1xuICAgICAgfVxuICAgIH1cblxuICAgIHN3aXRjaCAoQWN0aW9uTWFwW2FjdGlvbi50eXBlXSkge1xuICAgICAgY2FzZSBBY3Rpb25Db25zdC5CQUNLOlxuICAgICAgY2FzZSBBY3Rpb25Db25zdC5CQUNLX0FDVElPTjpcbiAgICAgIGNhc2UgQWN0aW9uQ29uc3QuUE9QX0FORF9SRVBMQUNFOlxuICAgICAgY2FzZSBBY3Rpb25Db25zdC5QT1BfVE86XG4gICAgICBjYXNlIEFjdGlvbkNvbnN0LlJFRlJFU0g6XG4gICAgICBjYXNlIEFjdGlvbkNvbnN0LlBVU0g6XG4gICAgICBjYXNlIEFjdGlvbkNvbnN0LlBVU0hfT1JfUE9QOlxuICAgICAgY2FzZSBBY3Rpb25Db25zdC5KVU1QOlxuICAgICAgY2FzZSBBY3Rpb25Db25zdC5SRVBMQUNFOlxuICAgICAgY2FzZSBBY3Rpb25Db25zdC5SRVNFVDpcbiAgICAgIGNhc2UgQWN0aW9uQ29uc3QuQU5EUk9JRF9CQUNLOlxuICAgICAgICByZXR1cm4gdXBkYXRlKHN0YXRlLCBhY3Rpb24pO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gc3RhdGU7XG5cbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IHJlZHVjZXI7XG4iXX0=
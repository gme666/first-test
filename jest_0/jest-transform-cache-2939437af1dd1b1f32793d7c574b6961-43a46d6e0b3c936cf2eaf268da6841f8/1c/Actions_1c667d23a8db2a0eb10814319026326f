f0cc00d9033a62c452774b551fe209fd
Object.defineProperty(exports,"__esModule",{value:true});exports.ActionsTest=exports.ActionMap=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _ActionMap;







var _Util=require('./Util');
var _Scene=require('./Scene');var _Scene2=_interopRequireDefault(_Scene);
var _ActionConst=require('./ActionConst');var ActionConst=_interopRequireWildcard(_ActionConst);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}

var ActionMap=exports.ActionMap=(_ActionMap={
jump:ActionConst.JUMP,
push:ActionConst.PUSH,
replace:ActionConst.REPLACE,
back:ActionConst.BACK,
BackAction:ActionConst.BACK_ACTION,
popAndReplace:ActionConst.POP_AND_REPLACE,
popTo:ActionConst.POP_TO,
refresh:ActionConst.REFRESH,
reset:ActionConst.RESET,
focus:ActionConst.FOCUS,
pushOrPop:ActionConst.PUSH_OR_POP,
androidBack:ActionConst.ANDROID_BACK},_defineProperty(_ActionMap,
ActionConst.JUMP,ActionConst.JUMP),_defineProperty(_ActionMap,
ActionConst.PUSH,ActionConst.PUSH),_defineProperty(_ActionMap,
ActionConst.REPLACE,ActionConst.REPLACE),_defineProperty(_ActionMap,
ActionConst.BACK,ActionConst.BACK),_defineProperty(_ActionMap,
ActionConst.BACK_ACTION,ActionConst.BACK_ACTION),_defineProperty(_ActionMap,
ActionConst.POP_AND_REPLACE,ActionConst.POP_AND_REPLACE),_defineProperty(_ActionMap,
ActionConst.POP_TO,ActionConst.POP_TO),_defineProperty(_ActionMap,
ActionConst.REFRESH,ActionConst.REFRESH),_defineProperty(_ActionMap,
ActionConst.RESET,ActionConst.RESET),_defineProperty(_ActionMap,
ActionConst.FOCUS,ActionConst.FOCUS),_defineProperty(_ActionMap,
ActionConst.PUSH_OR_POP,ActionConst.PUSH_OR_POP),_defineProperty(_ActionMap,
ActionConst.ANDROID_BACK,ActionConst.ANDROID_BACK),_ActionMap);


function filterParam(data){
if(data.toString()!=='[object Object]'){
return{data:data};
}
var proto=(data||{}).constructor.name;

if(!data||proto!=='Object'){
return{};
}
return data;
}

var reservedKeys=[
'create',
'callback',
'iterate',
'current'].concat(_toConsumableArray(
Object.keys(ActionMap)));


function getInheritProps(props){var

key=props.key,style=props.style,type=props.type,component=props.component,tabs=props.tabs,sceneKey=props.sceneKey,parent=props.parent,children=props.children,parentProps=_objectWithoutProperties(props,['key','style','type','component','tabs','sceneKey','parent','children']);
return parentProps.passProps?parentProps:{};
}var

Actions=function(){
function Actions(){_classCallCheck(this,Actions);
this.callback=null;
this.create=this.create.bind(this);
this.iterate=this.iterate.bind(this);
this.pop=this.pop.bind(this);
this.refresh=this.refresh.bind(this);
this.focus=this.focus.bind(this);
}_createClass(Actions,[{key:'iterate',value:function iterate(

root){var parentProps=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var _this=this;var refsParam=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var wrapBy=arguments[3];
var refs=refsParam;
(0,_Util.assert)(root.props,'props should be defined for stack');
var key=root.key;
(0,_Util.assert)(key,'unique key should be defined ');
(0,_Util.assert)(
reservedKeys.indexOf(key)===-1,'\''+
key+'\' is not allowed as key name. Reserved keys: ['+reservedKeys.join(', ')+']');var _root$props=

root.props,children=_root$props.children,component=_root$props.component,staticProps=_objectWithoutProperties(_root$props,['children','component']);
var type=root.props.type||(parentProps.tabs?ActionConst.JUMP:ActionConst.PUSH);
if(type==='switch'){
type=ActionConst.JUMP;
}
var inheritProps=getInheritProps(parentProps);
var componentProps=component?{component:wrapBy(component)}:{};

if(wrapBy){
Object.keys(staticProps).forEach(function(prop){
var componentClass=staticProps[prop];
if(componentClass&&componentClass.prototype&&componentClass.prototype.render){
componentProps[prop]=wrapBy(componentClass);
delete staticProps[prop];
}
});
}
var res=_extends({
key:key,
name:key,
sceneKey:key,
parent:parentProps.key,
type:type},
inheritProps,
staticProps,
componentProps);

var list=children||[];
var normalized=[];
if(!(list instanceof Array)){
list=[list];
}
list.forEach(function(item){
if(item){
if(item instanceof Array){
item.forEach(function(it){
normalized.push(it);
});
}else{
normalized.push(item);
}
}
});
list=normalized;

var condition=function condition(el){return!el.props.component&&!el.props.children&&!el.props.onPress&&(
!el.props.type||ActionMap[el.props.type]===ActionConst.REFRESH);};

var baseKey=root.key;
var subStateParent=parentProps.key;
var subStates=list.filter(condition);
list=list.filter(function(el){return!condition(el);});
if(list.length){
res.children=list.map(function(c){return _this.iterate(c,res,refs,wrapBy).key;});
}else{
if(!staticProps.onPress){
(0,_Util.assert)(component,'component property is not set for key='+key);
}

if(parentProps.tabs){
var innerKey=res.key+'_';
baseKey=innerKey;
subStateParent=res.key;
var inner=_extends({},res,{
name:key,
key:innerKey,
sceneKey:innerKey,
type:ActionConst.PUSH,
parent:res.key});
refs[innerKey]=inner;
res.children=[innerKey];
delete res.component;
}
res.index=0;
}var _loop=function _loop(

el){
refs[el.key]=_extends({key:el.key,
name:el.key},
el.props,{
type:ActionConst.REFRESH,
base:baseKey,
parent:subStateParent});
if(_this[el.key]){
console.log('Key '+el.key+' is already defined!');
}
_this[el.key]=
function(){var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};
(0,_Util.assert)(_this.callback,'Actions.callback is not defined!');
_this.callback(_extends({key:el.key,type:ActionConst.REFRESH},filterParam(props)));
};};for(var _iterator=subStates,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==='function'?Symbol.iterator:'@@iterator']();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var el=_ref;_loop(el);
}
if(this[key]){
console.log('Key '+key+' is already defined!');
}
this[key]=
function(){var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};
(0,_Util.assert)(_this.callback,'Actions.callback is not defined!');
_this.callback(_extends({key:key,type:type},filterParam(props)));
};
refs[res.key]=res;

return res;
}},{key:'popTo',value:function popTo()

{var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};
return this.callback(_extends({},filterParam(props),{type:ActionConst.POP_TO}));
}},{key:'pop',value:function pop()

{var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};
return this.callback(_extends({},filterParam(props),{type:ActionConst.BACK_ACTION}));
}},{key:'jump',value:function jump()

{var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};
return this.callback(_extends({},filterParam(props),{type:ActionConst.JUMP}));
}},{key:'refresh',value:function refresh()

{var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};
return this.callback(_extends({},filterParam(props),{type:ActionConst.REFRESH}));
}},{key:'focus',value:function focus()

{var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};
return this.callback(_extends({},filterParam(props),{type:ActionConst.FOCUS}));
}},{key:'androidBack',value:function androidBack()

{var props=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};
return this.callback(_extends({},filterParam(props),{type:ActionConst.ANDROID_BACK}));
}},{key:'create',value:function create(

scene){var wrapBy=arguments.length>1&&arguments[1]!==undefined?arguments[1]:function(x){return x;};
(0,_Util.assert)(scene,'root scene should be defined');
var refs={};
this.iterate(scene,{},refs,wrapBy);
return refs;
}}]);return Actions;}();exports.


ActionsTest=Actions;exports.default=
new Actions();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFjdGlvbnMuanMiXSwibmFtZXMiOlsiQWN0aW9uQ29uc3QiLCJBY3Rpb25NYXAiLCJqdW1wIiwiSlVNUCIsInB1c2giLCJQVVNIIiwicmVwbGFjZSIsIlJFUExBQ0UiLCJiYWNrIiwiQkFDSyIsIkJhY2tBY3Rpb24iLCJCQUNLX0FDVElPTiIsInBvcEFuZFJlcGxhY2UiLCJQT1BfQU5EX1JFUExBQ0UiLCJwb3BUbyIsIlBPUF9UTyIsInJlZnJlc2giLCJSRUZSRVNIIiwicmVzZXQiLCJSRVNFVCIsImZvY3VzIiwiRk9DVVMiLCJwdXNoT3JQb3AiLCJQVVNIX09SX1BPUCIsImFuZHJvaWRCYWNrIiwiQU5EUk9JRF9CQUNLIiwiZmlsdGVyUGFyYW0iLCJkYXRhIiwidG9TdHJpbmciLCJwcm90byIsImNvbnN0cnVjdG9yIiwibmFtZSIsInJlc2VydmVkS2V5cyIsIk9iamVjdCIsImtleXMiLCJnZXRJbmhlcml0UHJvcHMiLCJwcm9wcyIsImtleSIsInN0eWxlIiwidHlwZSIsImNvbXBvbmVudCIsInRhYnMiLCJzY2VuZUtleSIsInBhcmVudCIsImNoaWxkcmVuIiwicGFyZW50UHJvcHMiLCJwYXNzUHJvcHMiLCJBY3Rpb25zIiwiY2FsbGJhY2siLCJjcmVhdGUiLCJiaW5kIiwiaXRlcmF0ZSIsInBvcCIsInJvb3QiLCJyZWZzUGFyYW0iLCJ3cmFwQnkiLCJyZWZzIiwiaW5kZXhPZiIsImpvaW4iLCJzdGF0aWNQcm9wcyIsImluaGVyaXRQcm9wcyIsImNvbXBvbmVudFByb3BzIiwiZm9yRWFjaCIsInByb3AiLCJjb21wb25lbnRDbGFzcyIsInByb3RvdHlwZSIsInJlbmRlciIsInJlcyIsImxpc3QiLCJub3JtYWxpemVkIiwiQXJyYXkiLCJpdGVtIiwiaXQiLCJjb25kaXRpb24iLCJlbCIsIm9uUHJlc3MiLCJiYXNlS2V5Iiwic3ViU3RhdGVQYXJlbnQiLCJzdWJTdGF0ZXMiLCJmaWx0ZXIiLCJsZW5ndGgiLCJtYXAiLCJjIiwiaW5uZXJLZXkiLCJpbm5lciIs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ZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIFBhdmVsIEFrc29ub3ZcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICovXG5pbXBvcnQgeyBhc3NlcnQgfSBmcm9tICcuL1V0aWwnO1xuaW1wb3J0IFNjZW5lIGZyb20gJy4vU2NlbmUnO1xuaW1wb3J0ICogYXMgQWN0aW9uQ29uc3QgZnJvbSAnLi9BY3Rpb25Db25zdCc7XG5cbmV4cG9ydCBjb25zdCBBY3Rpb25NYXAgPSB7XG4gIGp1bXA6IEFjdGlvbkNvbnN0LkpVTVAsXG4gIHB1c2g6IEFjdGlvbkNvbnN0LlBVU0gsXG4gIHJlcGxhY2U6IEFjdGlvbkNvbnN0LlJFUExBQ0UsXG4gIGJhY2s6IEFjdGlvbkNvbnN0LkJBQ0ssXG4gIEJhY2tBY3Rpb246IEFjdGlvbkNvbnN0LkJBQ0tfQUNUSU9OLFxuICBwb3BBbmRSZXBsYWNlOiBBY3Rpb25Db25zdC5QT1BfQU5EX1JFUExBQ0UsXG4gIHBvcFRvOiBBY3Rpb25Db25zdC5QT1BfVE8sXG4gIHJlZnJlc2g6IEFjdGlvbkNvbnN0LlJFRlJFU0gsXG4gIHJlc2V0OiBBY3Rpb25Db25zdC5SRVNFVCxcbiAgZm9jdXM6IEFjdGlvbkNvbnN0LkZPQ1VTLFxuICBwdXNoT3JQb3A6IEFjdGlvbkNvbnN0LlBVU0hfT1JfUE9QLFxuICBhbmRyb2lkQmFjazogQWN0aW9uQ29uc3QuQU5EUk9JRF9CQUNLLFxuICBbQWN0aW9uQ29uc3QuSlVNUF06IEFjdGlvbkNvbnN0LkpVTVAsXG4gIFtBY3Rpb25Db25zdC5QVVNIXTogQWN0aW9uQ29uc3QuUFVTSCxcbiAgW0FjdGlvbkNvbnN0LlJFUExBQ0VdOiBBY3Rpb25Db25zdC5SRVBMQUNFLFxuICBbQWN0aW9uQ29uc3QuQkFDS106IEFjdGlvbkNvbnN0LkJBQ0ssXG4gIFtBY3Rpb25Db25zdC5CQUNLX0FDVElPTl06IEFjdGlvbkNvbnN0LkJBQ0tfQUNUSU9OLFxuICBbQWN0aW9uQ29uc3QuUE9QX0FORF9SRVBMQUNFXTogQWN0aW9uQ29uc3QuUE9QX0FORF9SRVBMQUNFLFxuICBbQWN0aW9uQ29uc3QuUE9QX1RPXTogQWN0aW9uQ29uc3QuUE9QX1RPLFxuICBbQWN0aW9uQ29uc3QuUkVGUkVTSF06IEFjdGlvbkNvbnN0LlJFRlJFU0gsXG4gIFtBY3Rpb25Db25zdC5SRVNFVF06IEFjdGlvbkNvbnN0LlJFU0VULFxuICBbQWN0aW9uQ29uc3QuRk9DVVNdOiBBY3Rpb25Db25zdC5GT0NVUyxcbiAgW0FjdGlvbkNvbnN0LlBVU0hfT1JfUE9QXTogQWN0aW9uQ29uc3QuUFVTSF9PUl9QT1AsXG4gIFtBY3Rpb25Db25zdC5BTkRST0lEX0JBQ0tdOiBBY3Rpb25Db25zdC5BTkRST0lEX0JBQ0ssXG59O1xuXG5mdW5jdGlvbiBmaWx0ZXJQYXJhbShkYXRhKSB7XG4gIGlmIChkYXRhLnRvU3RyaW5nKCkgIT09ICdbb2JqZWN0IE9iamVjdF0nKSB7XG4gICAgcmV0dXJuIHsgZGF0YSB9O1xuICB9XG4gIGNvbnN0IHByb3RvID0gKGRhdGEgfHwge30pLmNvbnN0cnVjdG9yLm5hbWU7XG4gIC8vIGF2b2lkIHBhc3NpbmcgUmVhY3QgTmF0aXZlIHBhcmFtZXRlcnNcbiAgaWYgKCFkYXRhIHx8IChwcm90byAhPT0gJ09iamVjdCcpKSB7XG4gICAgcmV0dXJuIHt9O1xuICB9XG4gIHJldHVybiBkYXRhO1xufVxuXG5jb25zdCByZXNlcnZlZEtleXMgPSBbXG4gICdjcmVhdGUnLFxuICAnY2FsbGJhY2snLFxuICAnaXRlcmF0ZScsXG4gICdjdXJyZW50JyxcbiAgLi4uT2JqZWN0LmtleXMoQWN0aW9uTWFwKSxcbl07XG5cbmZ1bmN0aW9uIGdldEluaGVyaXRQcm9wcyhwcm9wcykge1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnNcbiAgY29uc3QgeyBrZXksIHN0eWxlLCB0eXBlLCBjb21wb25lbnQsIHRhYnMsIHNjZW5lS2V5LCBwYXJlbnQsIGNoaWxkcmVuLCAuLi5wYXJlbnRQcm9wcyB9ID0gcHJvcHM7XG4gIHJldHVybiBwYXJlbnRQcm9wcy5wYXNzUHJvcHMgPyBwYXJlbnRQcm9wcyA6IHt9O1xufVxuXG5jbGFzcyBBY3Rpb25zIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5jYWxsYmFjayA9IG51bGw7XG4gICAgdGhpcy5jcmVhdGUgPSB0aGlzLmNyZWF0ZS5iaW5kKHRoaXMpO1xuICAgIHRoaXMuaXRlcmF0ZSA9IHRoaXMuaXRlcmF0ZS5iaW5kKHRoaXMpO1xuICAgIHRoaXMucG9wID0gdGhpcy5wb3AuYmluZCh0aGlzKTtcbiAgICB0aGlzLnJlZnJlc2ggPSB0aGlzLnJlZnJlc2guYmluZCh0aGlzKTtcbiAgICB0aGlzLmZvY3VzID0gdGhpcy5mb2N1cy5iaW5kKHRoaXMpO1xuICB9XG5cbiAgaXRlcmF0ZShyb290OiBTY2VuZSwgcGFyZW50UHJvcHMgPSB7fSwgcmVmc1BhcmFtID0ge30sIHdyYXBCeSkge1xuICAgIGNvbnN0IHJlZnMgPSByZWZzUGFyYW07XG4gICAgYXNzZXJ0KHJvb3QucHJvcHMsICdwcm9wcyBzaG91bGQgYmUgZGVmaW5lZCBmb3Igc3RhY2snKTtcbiAgICBjb25zdCBrZXkgPSByb290LmtleTtcbiAgICBhc3NlcnQoa2V5LCAndW5pcXVlIGtleSBzaG91bGQgYmUgZGVmaW5lZCAnKTtcbiAgICBhc3NlcnQoXG4gICAgICByZXNlcnZlZEtleXMuaW5kZXhPZihrZXkpID09PSAtMSxcbiAgICAgIGAnJHtrZXl9JyBpcyBub3QgYWxsb3dlZCBhcyBrZXkgbmFtZS4gUmVzZXJ2ZWQga2V5czogWyR7cmVzZXJ2ZWRLZXlzLmpvaW4oJywgJyl9XWAsXG4gICAgKTtcbiAgICBjb25zdCB7IGNoaWxkcmVuLCBjb21wb25lbnQsIC4uLnN0YXRpY1Byb3BzIH0gPSByb290LnByb3BzO1xuICAgIGxldCB0eXBlID0gcm9vdC5wcm9wcy50eXBlIHx8IChwYXJlbnRQcm9wcy50YWJzID8gQWN0aW9uQ29uc3QuSlVNUCA6IEFjdGlvbkNvbnN0LlBVU0gpO1xuICAgIGlmICh0eXBlID09PSAnc3dpdGNoJykge1xuICAgICAgdHlwZSA9IEFjdGlvbkNvbnN0LkpVTVA7XG4gICAgfVxuICAgIGNvbnN0IGluaGVyaXRQcm9wcyA9IGdldEluaGVyaXRQcm9wcyhwYXJlbnRQcm9wcyk7XG4gICAgY29uc3QgY29tcG9uZW50UHJvcHMgPSBjb21wb25lbnQgPyB7IGNvbXBvbmVudDogd3JhcEJ5KGNvbXBvbmVudCkgfSA6IHt9O1xuICAgIC8vIHdyYXAgb3RoZXIgY29tcG9uZW50c1xuICAgIGlmICh3cmFwQnkpIHtcbiAgICAgIE9iamVjdC5rZXlzKHN0YXRpY1Byb3BzKS5mb3JFYWNoKChwcm9wKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbXBvbmVudENsYXNzID0gc3RhdGljUHJvcHNbcHJvcF07XG4gICAgICAgIGlmIChjb21wb25lbnRDbGFzcyAmJiBjb21wb25lbnRDbGFzcy5wcm90b3R5cGUgJiYgY29tcG9uZW50Q2xhc3MucHJvdG90eXBlLnJlbmRlcikge1xuICAgICAgICAgIGNvbXBvbmVudFByb3BzW3Byb3BdID0gd3JhcEJ5KGNvbXBvbmVudENsYXNzKTtcbiAgICAgICAgICBkZWxldGUgc3RhdGljUHJvcHNbcHJvcF07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCByZXMgPSB7XG4gICAgICBrZXksXG4gICAgICBuYW1lOiBrZXksXG4gICAgICBzY2VuZUtleToga2V5LFxuICAgICAgcGFyZW50OiBwYXJlbnRQcm9wcy5rZXksXG4gICAgICB0eXBlLFxuICAgICAgLi4uaW5oZXJpdFByb3BzLFxuICAgICAgLi4uc3RhdGljUHJvcHMsXG4gICAgICAuLi5jb21wb25lbnRQcm9wcyxcbiAgICB9O1xuICAgIGxldCBsaXN0ID0gY2hpbGRyZW4gfHwgW107XG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IFtdO1xuICAgIGlmICghKGxpc3QgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgIGxpc3QgPSBbbGlzdF07XG4gICAgfVxuICAgIGxpc3QuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgIGl0ZW0uZm9yRWFjaCgoaXQpID0+IHtcbiAgICAgICAgICAgIG5vcm1hbGl6ZWQucHVzaChpdCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbm9ybWFsaXplZC5wdXNoKGl0ZW0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgbGlzdCA9IG5vcm1hbGl6ZWQ7IC8vIG5vcm1hbGl6ZSB0aGUgbGlzdCBvZiBzY2VuZXNcblxuICAgIGNvbnN0IGNvbmRpdGlvbiA9IGVsID0+ICghZWwucHJvcHMuY29tcG9uZW50ICYmICFlbC5wcm9wcy5jaGlsZHJlbiAmJiAhZWwucHJvcHMub25QcmVzcyAmJlxuICAgICghZWwucHJvcHMudHlwZSB8fCBBY3Rpb25NYXBbZWwucHJvcHMudHlwZV0gPT09IEFjdGlvbkNvbnN0LlJFRlJFU0gpKTtcbiAgICAvLyBkZXRlcm1pbmUgc3ViLXN0YXRlc1xuICAgIGxldCBiYXNlS2V5ID0gcm9vdC5rZXk7XG4gICAgbGV0IHN1YlN0YXRlUGFyZW50ID0gcGFyZW50UHJvcHMua2V5O1xuICAgIGNvbnN0IHN1YlN0YXRlcyA9IGxpc3QuZmlsdGVyKGNvbmRpdGlvbik7XG4gICAgbGlzdCA9IGxpc3QuZmlsdGVyKGVsID0+ICFjb25kaXRpb24oZWwpKTtcbiAgICBpZiAobGlzdC5sZW5ndGgpIHtcbiAgICAgIHJlcy5jaGlsZHJlbiA9IGxpc3QubWFwKGMgPT4gdGhpcy5pdGVyYXRlKGMsIHJlcywgcmVmcywgd3JhcEJ5KS5rZXkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIXN0YXRpY1Byb3BzLm9uUHJlc3MpIHtcbiAgICAgICAgYXNzZXJ0KGNvbXBvbmVudCwgYGNvbXBvbmVudCBwcm9wZXJ0eSBpcyBub3Qgc2V0IGZvciBrZXk9JHtrZXl9YCk7XG4gICAgICB9XG4gICAgICAvLyB3cmFwIHNjZW5lIGlmIHBhcmVudCBpcyBcInRhYnNcIlxuICAgICAgaWYgKHBhcmVudFByb3BzLnRhYnMpIHtcbiAgICAgICAgY29uc3QgaW5uZXJLZXkgPSBgJHtyZXMua2V5fV9gO1xuICAgICAgICBiYXNlS2V5ID0gaW5uZXJLZXk7XG4gICAgICAgIHN1YlN0YXRlUGFyZW50ID0gcmVzLmtleTtcbiAgICAgICAgY29uc3QgaW5uZXIgPSB7IC4uLnJlcyxcbiAgICAgICAgICBuYW1lOiBrZXksXG4gICAgICAgICAga2V5OiBpbm5lcktleSxcbiAgICAgICAgICBzY2VuZUtleTogaW5uZXJLZXksXG4gICAgICAgICAgdHlwZTogQWN0aW9uQ29uc3QuUFVTSCxcbiAgICAgICAgICBwYXJlbnQ6IHJlcy5rZXkgfTtcbiAgICAgICAgcmVmc1tpbm5lcktleV0gPSBpbm5lcjtcbiAgICAgICAgcmVzLmNoaWxkcmVuID0gW2lubmVyS2V5XTtcbiAgICAgICAgZGVsZXRlIHJlcy5jb21wb25lbnQ7XG4gICAgICB9XG4gICAgICByZXMuaW5kZXggPSAwO1xuICAgIH1cbiAgICAvLyBwcm9jZXNzIHN1YnN0YXRlc1xuICAgIGZvciAoY29uc3QgZWwgb2Ygc3ViU3RhdGVzKSB7XG4gICAgICByZWZzW2VsLmtleV0gPSB7IGtleTogZWwua2V5LFxuICAgICAgICBuYW1lOiBlbC5rZXksXG4gICAgICAgIC4uLmVsLnByb3BzLFxuICAgICAgICB0eXBlOiBBY3Rpb25Db25zdC5SRUZSRVNILFxuICAgICAgICBiYXNlOiBiYXNlS2V5LFxuICAgICAgICBwYXJlbnQ6IHN1YlN0YXRlUGFyZW50IH07XG4gICAgICBpZiAodGhpc1tlbC5rZXldKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBLZXkgJHtlbC5rZXl9IGlzIGFscmVhZHkgZGVmaW5lZCFgKTtcbiAgICAgIH1cbiAgICAgIHRoaXNbZWwua2V5XSA9XG4gICAgICAgIChwcm9wcyA9IHt9KSA9PiB7XG4gICAgICAgICAgYXNzZXJ0KHRoaXMuY2FsbGJhY2ssICdBY3Rpb25zLmNhbGxiYWNrIGlzIG5vdCBkZWZpbmVkIScpO1xuICAgICAgICAgIHRoaXMuY2FsbGJhY2soeyBrZXk6IGVsLmtleSwgdHlwZTogQWN0aW9uQ29uc3QuUkVGUkVTSCwgLi4uZmlsdGVyUGFyYW0ocHJvcHMpIH0pO1xuICAgICAgICB9O1xuICAgIH1cbiAgICBpZiAodGhpc1trZXldKSB7XG4gICAgICBjb25zb2xlLmxvZyhgS2V5ICR7a2V5fSBpcyBhbHJlYWR5IGRlZmluZWQhYCk7XG4gICAgfVxuICAgIHRoaXNba2V5XSA9XG4gICAgICAocHJvcHMgPSB7fSkgPT4ge1xuICAgICAgICBhc3NlcnQodGhpcy5jYWxsYmFjaywgJ0FjdGlvbnMuY2FsbGJhY2sgaXMgbm90IGRlZmluZWQhJyk7XG4gICAgICAgIHRoaXMuY2FsbGJhY2soeyBrZXksIHR5cGUsIC4uLmZpbHRlclBhcmFtKHByb3BzKSB9KTtcbiAgICAgIH07XG4gICAgcmVmc1tyZXMua2V5XSA9IHJlcztcblxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBwb3BUbyhwcm9wcyA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMuY2FsbGJhY2soeyAuLi5maWx0ZXJQYXJhbShwcm9wcyksIHR5cGU6IEFjdGlvbkNvbnN0LlBPUF9UTyB9KTtcbiAgfVxuXG4gIHBvcChwcm9wcyA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMuY2FsbGJhY2soeyAuLi5maWx0ZXJQYXJhbShwcm9wcyksIHR5cGU6IEFjdGlvbkNvbnN0LkJBQ0tfQUNUSU9OIH0pO1xuICB9XG5cbiAganVtcChwcm9wcyA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMuY2FsbGJhY2soeyAuLi5maWx0ZXJQYXJhbShwcm9wcyksIHR5cGU6IEFjdGlvbkNvbnN0LkpVTVAgfSk7XG4gIH1cblxuICByZWZyZXNoKHByb3BzID0ge30pIHtcbiAgICByZXR1cm4gdGhpcy5jYWxsYmFjayh7IC4uLmZpbHRlclBhcmFtKHByb3BzKSwgdHlwZTogQWN0aW9uQ29uc3QuUkVGUkVTSCB9KTtcbiAgfVxuXG4gIGZvY3VzKHByb3BzID0ge30pIHtcbiAgICByZXR1cm4gdGhpcy5jYWxsYmFjayh7IC4uLmZpbHRlclBhcmFtKHByb3BzKSwgdHlwZTogQWN0aW9uQ29uc3QuRk9DVVMgfSk7XG4gIH1cblxuICBhbmRyb2lkQmFjayhwcm9wcyA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMuY2FsbGJhY2soeyAuLi5maWx0ZXJQYXJhbShwcm9wcyksIHR5cGU6IEFjdGlvbkNvbnN0LkFORFJPSURfQkFDSyB9KTtcbiAgfVxuXG4gIGNyZWF0ZShzY2VuZTpTY2VuZSwgd3JhcEJ5ID0geCA9PiB4KSB7XG4gICAgYXNzZXJ0KHNjZW5lLCAncm9vdCBzY2VuZSBzaG91bGQgYmUgZGVmaW5lZCcpO1xuICAgIGNvbnN0IHJlZnMgPSB7fTtcbiAgICB0aGlzLml0ZXJhdGUoc2NlbmUsIHt9LCByZWZzLCB3cmFwQnkpO1xuICAgIHJldHVybiByZWZzO1xuICB9XG59XG5cbmV4cG9ydCB7IEFjdGlvbnMgYXMgQWN0aW9uc1Rlc3QgfTtcbmV4cG9ydCBkZWZhdWx0IG5ldyBBY3Rpb25zKCk7XG4iXX0=